<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upgrade - Pimp My Epstein</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f23;
      min-height: 100vh;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      width: 100%;
      text-align: center;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      opacity: 0;
      animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    .logo {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #a1a1aa;
      font-size: 1.1rem;
      margin-bottom: 32px;
    }

    .pricing-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(26, 26, 46, 0.8);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: left;
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: rgba(239, 68, 68, 0.3);
      transform: translateY(-4px);
    }

    .card.featured {
      border-color: #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(26, 26, 46, 0.8));
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .badge {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .price {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .price span {
      font-size: 1rem;
      font-weight: 400;
      color: #a1a1aa;
    }

    .price-description {
      color: #71717a;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .features {
      list-style: none;
      margin-bottom: 24px;
    }

    .features li {
      padding: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #d4d4d8;
      font-size: 0.95rem;
    }

    .check {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .check svg {
      width: 12px;
      height: 12px;
      stroke: white;
    }

    .btn {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn .spinner {
      display: none;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .btn.loading .spinner {
      display: block;
    }

    .btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .quantity-selector label {
      color: #a1a1aa;
      font-size: 0.9rem;
    }

    .quantity-selector input {
      width: 70px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      text-align: center;
    }

    .quantity-selector input:focus {
      outline: none;
      border-color: #ef4444;
    }

    .credit-total {
      color: #a1a1aa;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      display: none;
    }

    .error.visible {
      display: block;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }

    .success-message {
      display: none;
    }

    .success-message.visible {
      display: block;
    }

    .success-message h2 {
      color: #22c55e;
      margin-bottom: 16px;
    }

    .success-message p {
      color: #a1a1aa;
      margin-bottom: 24px;
    }

    .canceled-notice {
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid #fbbf24;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 24px;
      display: none;
    }

    .canceled-notice.visible {
      display: block;
    }

    .back-link {
      color: #71717a;
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.2s ease;
    }

    .back-link:hover {
      color: #fff;
    }

    .guarantee {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #71717a;
      font-size: 0.85rem;
      margin-top: 24px;
    }

    .guarantee svg {
      width: 16px;
      height: 16px;
    }

    .manage-subscription {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .manage-link {
      color: #a1a1aa;
      text-decoration: underline;
      font-size: 0.9rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .manage-link:hover {
      color: #fff;
    }

    .auth-required {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .auth-required.visible {
      display: block;
    }

    .auth-required h2 {
      margin-bottom: 16px;
    }

    .auth-required p {
      color: #a1a1aa;
      margin-bottom: 24px;
    }

    @media (max-width: 700px) {
      .pricing-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.6rem;
      }

      .card {
        padding: 24px;
      }

      .price {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Success message (shown after successful payment) -->
    <div class="success-message" id="successMessage">
      <div class="logo fade-in-up">&#127881;</div>
      <h2 class="fade-in-up delay-1" id="successTitle">Welcome to Base!</h2>
      <p class="fade-in-up delay-2" id="successText">Your subscription is now active. Enjoy 50 watermark-free images per month!</p>
      <a href="/" class="btn btn-primary fade-in-up delay-3">Start Creating</a>
    </div>

    <!-- Auth required message -->
    <div class="auth-required" id="authRequired">
      <div class="logo">&#128274;</div>
      <h2>Sign In Required</h2>
      <p>Please sign in to purchase a subscription or credits.</p>
      <a href="/" class="btn btn-primary">Go to App</a>
    </div>

    <!-- Main pricing page -->
    <div id="pricingPage">
      <div class="logo fade-in-up">&#127941;</div>
      <h1 class="fade-in-up delay-1">Pimp My Epstein</h1>
      <p class="subtitle fade-in-up delay-2">Remove watermarks and create more images</p>

      <div class="canceled-notice" id="canceledNotice">
        Your checkout was canceled. Ready to try again?
      </div>

      <div class="error" id="error"></div>

      <div class="pricing-grid fade-in-up delay-3">
        <!-- Base Subscription -->
        <div class="card featured">
          <div class="card-header">
            <span class="card-title">Base Plan</span>
            <span class="badge">Best Value</span>
          </div>
          <div class="price">$14.99<span>/month</span></div>
          <p class="price-description">50 watermark-free images per month</p>

          <ul class="features">
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              50 watermark-free images/month
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              High-quality downloads
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              Priority processing
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              Cancel anytime
            </li>
          </ul>

          <button class="btn btn-primary" id="subscribeBtn">
            <span class="spinner"></span>
            <span class="btn-text">Subscribe Now</span>
          </button>
        </div>

        <!-- Credit Pack -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Credit Pack</span>
          </div>
          <div class="price">$3.00<span>/pack</span></div>
          <p class="price-description">3 credits for watermark-free images</p>

          <ul class="features">
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              3 watermark-free images ($1 each)
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              Or remove watermark from existing
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              Credits never expire
            </li>
            <li>
              <div class="check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              Use anytime
            </li>
          </ul>

          <div class="quantity-selector">
            <label for="creditQty">Packs:</label>
            <input type="number" id="creditQty" value="1" min="1" max="100">
          </div>
          <p class="credit-total" id="creditTotal">Total: $3.00 (3 credits)</p>

          <button class="btn btn-secondary" id="buyCreditsBtn">
            <span class="spinner"></span>
            <span class="btn-text">Buy Credit Pack</span>
          </button>
        </div>
      </div>

      <a href="/" class="back-link fade-in-up delay-4">&larr; Back to Pimp My Epstein</a>

      <div class="guarantee fade-in-up delay-4">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        <span>Secure payment via Stripe</span>
      </div>

      <div class="manage-subscription" id="manageSection" style="display: none;">
        <span class="manage-link" id="manageLink">Manage your subscription</span>
      </div>
    </div>
  </div>

  <script>
    // Check URL params for success/cancel states
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const creditsPurchased = urlParams.get('credits_purchased');
    const canceled = urlParams.get('canceled');

    // Elements
    const pricingPage = document.getElementById('pricingPage');
    const successMessage = document.getElementById('successMessage');
    const successTitle = document.getElementById('successTitle');
    const successText = document.getElementById('successText');
    const authRequired = document.getElementById('authRequired');
    const canceledNotice = document.getElementById('canceledNotice');
    const errorDiv = document.getElementById('error');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const buyCreditsBtn = document.getElementById('buyCreditsBtn');
    const creditQtyInput = document.getElementById('creditQty');
    const creditTotalEl = document.getElementById('creditTotal');
    const manageSection = document.getElementById('manageSection');
    const manageLink = document.getElementById('manageLink');

    // Get auth token from Supabase session
    async function getAuthToken() {
      // Try to get token from localStorage (Supabase v2 uses sb-{project_ref}-auth-token format)
      const storageKey = Object.keys(localStorage).find(k =>
        k.includes('supabase.auth') || k.startsWith('sb-') && k.endsWith('-auth-token')
      );
      if (storageKey) {
        try {
          const session = JSON.parse(localStorage.getItem(storageKey));
          // Supabase v2 stores access_token directly, or nested in session object
          return session?.access_token || session?.session?.access_token || null;
        } catch (e) {
          return null;
        }
      }
      return null;
    }

    // Check auth and show appropriate view
    async function init() {
      // Show success message if returning from successful checkout
      if (sessionId) {
        pricingPage.style.display = 'none';

        // Verify the session and update profile (fallback for when webhooks don't work)
        const token = await getAuthToken();
        if (token) {
          try {
            const response = await fetch('/api/verify-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ sessionId })
            });
            const result = await response.json();
            if (result.success) {
              console.log('Session verified:', result);
            }
          } catch (err) {
            console.warn('Could not verify session:', err);
          }
        }

        if (creditsPurchased) {
          successTitle.textContent = 'Credits Added!';
          successText.textContent = `${creditsPurchased} credit(s) have been added to your account.`;
        }

        successMessage.classList.add('visible');
        return;
      }

      // Show canceled notice if checkout was canceled
      if (canceled === 'true') {
        canceledNotice.classList.add('visible');
      }

      // Check if user is authenticated
      const token = await getAuthToken();
      if (!token) {
        pricingPage.style.display = 'none';
        authRequired.classList.add('visible');
        return;
      }

      // Check if user has a subscription (show manage link)
      try {
        const response = await fetch('/api/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();

        if (data.profile?.stripe_customer_id) {
          manageSection.style.display = 'block';
        }
      } catch (e) {
        // Ignore - just don't show manage link
      }
    }

    // Update credit total when quantity changes
    creditQtyInput.addEventListener('input', () => {
      const qty = Math.max(1, Math.min(100, parseInt(creditQtyInput.value) || 1));
      creditTotalEl.textContent = `Total: $${(qty * 3).toFixed(2)} (${qty * 3} credits)`;
    });

    // Show error
    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.add('visible');
    }

    // Hide error
    function hideError() {
      errorDiv.classList.remove('visible');
    }

    // Set button loading state
    function setLoading(btn, loading) {
      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    // Subscribe button click
    subscribeBtn.addEventListener('click', async () => {
      hideError();
      const token = await getAuthToken();

      if (!token) {
        showError('Please sign in first');
        return;
      }

      setLoading(subscribeBtn, true);

      try {
        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        } else {
          throw new Error('No checkout URL received');
        }
      } catch (error) {
        setLoading(subscribeBtn, false);
        showError(error.message || 'Something went wrong. Please try again.');
      }
    });

    // Buy credits button click
    buyCreditsBtn.addEventListener('click', async () => {
      hideError();
      const token = await getAuthToken();

      if (!token) {
        showError('Please sign in first');
        return;
      }

      const quantity = Math.max(1, Math.min(100, parseInt(creditQtyInput.value) || 1));
      setLoading(buyCreditsBtn, true);

      try {
        const response = await fetch('/api/buy-credits', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ quantity })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        } else {
          throw new Error('No checkout URL received');
        }
      } catch (error) {
        setLoading(buyCreditsBtn, false);
        showError(error.message || 'Something went wrong. Please try again.');
      }
    });

    // Manage subscription link click
    manageLink.addEventListener('click', async () => {
      const token = await getAuthToken();

      if (!token) {
        showError('Please sign in first');
        return;
      }

      try {
        const response = await fetch('/api/customer-portal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        if (data.portalUrl) {
          window.location.href = data.portalUrl;
        } else {
          throw new Error('No portal URL received');
        }
      } catch (error) {
        showError(error.message || 'Failed to open subscription management.');
      }
    });

    // Initialize
    init();
  </script>
</body>
</html>
