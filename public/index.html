<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIMP MY EPSTEIN</title>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- VCR OSD Mono font for VHS aesthetic -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       PIMP MY EPSTEIN - MDE WORLD PEACE AESTHETIC
       VHS / Glitch / Anti-Design / Raw
       ======================================== */

    @font-face {
      font-family: 'VCR';
      src: local('VT323'), local('Courier New');
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* VHS Scan Lines Overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      background: repeating-linear-gradient(0deg,
          rgba(0, 0, 0, 0.15) 0px,
          rgba(0, 0, 0, 0.15) 1px,
          transparent 1px,
          transparent 2px);
      animation: scanlines 0.1s linear infinite;
    }

    @keyframes scanlines {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(2px);
      }
    }

    /* Random screen flicker */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background: transparent;
      animation: flicker 0.15s infinite;
    }

    @keyframes flicker {
      0% {
        opacity: 0.97;
      }

      5% {
        opacity: 0.95;
      }

      10% {
        opacity: 0.97;
      }

      15% {
        opacity: 0.94;
      }

      20% {
        opacity: 0.98;
      }

      50% {
        opacity: 0.96;
      }

      80% {
        opacity: 0.97;
      }

      90% {
        opacity: 0.94;
      }

      100% {
        opacity: 0.98;
      }
    }

    body {
      font-family: 'VT323', 'Courier New', monospace;
      background: #000;
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
      image-rendering: pixelated;
      letter-spacing: 1px;
    }

    /* Chromatic aberration on container */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
    }

    /* Glitch text effect */
    @keyframes glitch {
      0% {
        text-shadow: 2px 0 #ff0000, -2px 0 #00ffff;
        transform: translate(0);
      }

      20% {
        text-shadow: -2px 0 #ff0000, 2px 0 #00ffff;
        transform: translate(-2px, 2px);
      }

      40% {
        text-shadow: 2px 0 #ff0000, -2px 0 #00ffff;
        transform: translate(2px, -2px);
      }

      60% {
        text-shadow: -2px 0 #ff0000, 2px 0 #00ffff;
        transform: translate(0);
      }

      80% {
        text-shadow: 2px 0 #ff0000, -2px 0 #00ffff;
        transform: translate(-2px, -2px);
      }

      100% {
        text-shadow: 2px 0 #ff0000, -2px 0 #00ffff;
        transform: translate(0);
      }
    }

    @keyframes glitchHard {

      0%,
      90%,
      100% {
        clip-path: inset(0 0 0 0);
        transform: translate(0);
      }

      92% {
        clip-path: inset(40% 0 30% 0);
        transform: translate(-5px, 0);
      }

      94% {
        clip-path: inset(10% 0 60% 0);
        transform: translate(5px, 0);
      }

      96% {
        clip-path: inset(70% 0 10% 0);
        transform: translate(-3px, 0);
      }

      98% {
        clip-path: inset(30% 0 50% 0);
        transform: translate(3px, 0);
      }
    }

    /* Harsh fade in */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px) skewX(-2deg);
        filter: blur(2px);
      }

      to {
        opacity: 1;
        transform: translateY(0) skewX(0);
        filter: blur(0);
      }
    }

    .fade-in-up {
      opacity: 0;
      animation: fadeInUp 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .fade-in-up.delay-1 {
      animation-delay: 0.1s;
    }

    .fade-in-up.delay-2 {
      animation-delay: 0.2s;
    }

    .fade-in-up.delay-3 {
      animation-delay: 0.3s;
    }

    .fade-in-up.delay-4 {
      animation-delay: 0.4s;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
    }

    /* VHS recording indicator - dynamic via JS */
    .rec-indicator {
      position: absolute;
      top: -20px;
      right: 20px;
      color: #ff0000;
      font-family: 'VT323', monospace;
      font-size: 1rem;
      letter-spacing: 1px;
      animation: blink 1s infinite;
    }

    .rec-indicator.disconnected {
      animation: glitch 0.3s infinite;
      color: #ff0000;
    }

    @keyframes glitch {
      0% {
        transform: translate(0);
        opacity: 1;
      }

      20% {
        transform: translate(-2px, 1px);
        opacity: 0.8;
      }

      40% {
        transform: translate(2px, -1px);
        opacity: 0.9;
      }

      60% {
        transform: translate(-1px, 2px);
        opacity: 0.7;
      }

      80% {
        transform: translate(1px, -2px);
        opacity: 0.8;
      }

      100% {
        transform: translate(0);
        opacity: 1;
      }
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      51%,
      100% {
        opacity: 0;
      }
    }

    h1 {
      font-family: 'Press Start 2P', 'VT323', monospace;
      font-size: 2.2rem;
      margin-bottom: 12px;
      color: #fff;
      letter-spacing: 4px;
      text-transform: uppercase;
      animation: glitch 0.3s infinite;
      text-shadow:
        3px 3px 0 #ff0000,
        -3px -3px 0 #00ffff,
        6px 0 0 #ff00ff;
      line-height: 1.4;
    }

    .subtitle {
      color: #ffff00;
      font-size: 1.4rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      border: 2px solid #ffff00;
      display: inline-block;
      padding: 8px 16px;
      background: rgba(255, 255, 0, 0.1);
      animation: glitchHard 4s infinite;
    }

    .usage-badge {
      display: inline-block;
      background: #ff0000;
      color: #000;
      padding: 8px 16px;
      font-size: 1rem;
      margin-top: 16px;
      transition: all 0.3s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: 3px solid #fff;
      box-shadow: 4px 4px 0 #fff;
      transform: rotate(-1deg);
    }

    .parody-disclaimer {
      display: inline-block;
      margin-top: 16px;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-family: 'VT323', monospace;
      color: #00ffff;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: 2px dashed #00ffff;
      background: rgba(0, 255, 255, 0.08);
      box-shadow: 3px 3px 0 #00ffff;
    }

    .usage-badge.debug {
      background: #00ff00;
      color: #000;
      border-color: #00ff00;
      box-shadow: 4px 4px 0 #00ff00;
    }

    /* Brutal card style */
    .card {
      background: #111;
      border: 4px solid #fff;
      padding: 24px;
      margin-bottom: 20px;
      position: relative;
      box-shadow: 8px 8px 0 #ff0000, -2px -2px 0 #00ffff;
      transform: rotate(0.5deg);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:nth-child(even) {
      transform: rotate(-0.5deg);
      box-shadow: 8px 8px 0 #00ffff, -2px -2px 0 #ff0000;
    }

    .card:hover {
      transform: rotate(0deg) scale(1.01);
      box-shadow: 12px 12px 0 #ff00ff;
    }

    /* Static noise on cards */
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>');
      opacity: 0.03;
      pointer-events: none;
      mix-blend-mode: overlay;
    }

    .card-title {
      font-size: 1.4rem;
      font-weight: 400;
      margin-bottom: 16px;
      color: #00ffff;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      border-bottom: 2px dashed #00ffff;
      padding-bottom: 8px;
    }

    /* Photo gallery grid */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }

    @media (min-width: 640px) {
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }

    .gallery-item {
      aspect-ratio: 1;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid #333;
      transition: all 0.2s ease;
      position: relative;
      background: #000;
      filter: grayscale(30%) contrast(1.2);
    }

    .gallery-item::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
          transparent 0%,
          rgba(255, 0, 255, 0.2) 50%,
          transparent 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1;
      pointer-events: none;
      animation: vhsLine 2s linear infinite;
    }

    @keyframes vhsLine {
      0% {
        transform: translateY(-100%);
      }

      100% {
        transform: translateY(100%);
      }
    }

    .gallery-item:hover {
      border-color: #ff00ff;
      filter: grayscale(0%) contrast(1.3) saturate(1.5);
      transform: scale(1.05);
      box-shadow: 0 0 20px #ff00ff;
    }

    .gallery-item:hover::before {
      opacity: 1;
    }

    .gallery-item.selected {
      border-color: #00ff00;
      box-shadow: 0 0 30px #00ff00, inset 0 0 20px rgba(0, 255, 0, 0.3);
      filter: grayscale(0%) contrast(1.2);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover img {
      transform: scale(1.15);
    }

    .gallery-item .check {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 28px;
      height: 28px;
      background: #00ff00;
      color: #000;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      z-index: 2;
      font-family: 'VT323', monospace;
      border: 2px solid #000;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0) rotate(180deg);
      }

      to {
        transform: scale(1) rotate(0deg);
      }
    }

    .gallery-item.selected .check {
      display: flex;
      animation: scaleIn 0.3s ease;
    }

    .btn-random {
      background: #ffff00;
      border: 3px solid #000;
      color: #000;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1.1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.2s ease;
      box-shadow: 4px 4px 0 #000;
    }

    .btn-random:hover {
      background: #ff00ff;
      color: #fff;
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
    }

    .btn-random:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    /* Upload zone */
    .upload-zone {
      border: 4px dashed #ff0000;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      background: repeating-linear-gradient(45deg,
          #111 0px,
          #111 10px,
          #0a0a0a 10px,
          #0a0a0a 20px);
    }

    .upload-zone::before {
      content: 'DROP ZONE';
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 0.8rem;
      color: #ff0000;
      font-family: 'VT323', monospace;
      letter-spacing: 2px;
    }

    .upload-zone:hover {
      border-color: #00ff00;
      background: repeating-linear-gradient(45deg,
          #001100 0px,
          #001100 10px,
          #002200 10px,
          #002200 20px);
    }

    .upload-zone.has-file {
      border-color: #00ff00;
      border-style: solid;
      background: #001100;
    }

    .upload-zone.has-file::before {
      content: 'LOADED';
      color: #00ff00;
    }

    .upload-zone.dragover {
      border-color: #ffff00;
      background: #111100;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      transition: transform 0.3s ease;
    }

    .upload-icon svg {
      stroke: #ff0000;
    }

    .upload-zone:hover .upload-icon {
      transform: scale(1.2) rotate(5deg);
    }

    .upload-zone:hover .upload-icon svg {
      stroke: #00ff00;
    }

    .upload-text {
      color: #fff;
      margin-bottom: 4px;
      font-family: 'VT323', monospace;
      font-size: 1.3rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .upload-hint {
      color: #666;
      font-size: 1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .preview-container {
      display: none;
      margin-top: 16px;
    }

    .preview-container.visible {
      display: block;
      animation: fadeInUp 0.4s ease;
    }

    .preview-img {
      max-width: 150px;
      max-height: 150px;
      margin: 0 auto;
      display: block;
      border: 4px solid #00ff00;
      filter: contrast(1.1) saturate(1.2);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }

    input[type="file"] {
      display: none;
    }

    /* Generate button - MAXIMUM IMPACT */
    .btn-generate {
      width: 100%;
      padding: 20px;
      font-size: 1.6rem;
      font-weight: 400;
      border: 4px solid #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #ff0000;
      color: #fff;
      position: relative;
      overflow: hidden;
      font-family: 'Press Start 2P', 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      box-shadow: 8px 8px 0 #000;
    }

    .btn-generate::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent);
      transition: left 0.5s ease;
      z-index: -1;
      pointer-events: none;
    }

    .btn-generate:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-generate span {
      position: relative;
      z-index: 2;
    }

    .btn-generate:hover:not(:disabled) {
      background: #00ff00;
      color: #000;
      transform: translate(-4px, -4px);
      box-shadow: 12px 12px 0 #ff0000;
    }

    .btn-generate:hover:not(:disabled) span {
      color: #000;
    }

    .btn-generate:active:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 4px 4px 0 #000;
    }

    .btn-generate:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Dual generate buttons container */
    .generate-buttons {
      display: flex;
      gap: 12px;
      width: 100%;
    }

    .generate-buttons .btn-generate {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 16px 12px;
    }

    .generate-buttons .btn-generate small {
      font-size: 0.7rem;
      opacity: 0.8;
      font-family: 'VT323', monospace;
    }

    /* Quick button - green accent */
    .btn-quick {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a3a0a 100%);
      border-color: #00ff00;
    }

    .btn-quick:hover:not(:disabled) {
      background: #00ff00;
    }

    .btn-quick::before {
      background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.4), transparent);
    }

    /* Premium button - gold accent */
    .btn-premium {
      background: linear-gradient(135deg, #1a1a1a 0%, #3a2a0a 100%);
      border-color: #ffd700;
      color: #ffd700;
    }

    .btn-premium span {
      color: #ffd700;
    }

    .btn-premium:hover:not(:disabled) {
      background: #ffd700;
      color: #000;
    }

    .btn-premium:hover:not(:disabled) span {
      color: #000;
    }

    .btn-premium::before {
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
    }

    /* Disabled state for generate buttons */
    .btn-quick:disabled,
    .btn-premium:disabled {
      background: #1a1a1a;
      border-color: #444;
    }

    .btn-quick:disabled span,
    .btn-premium:disabled span {
      color: #666;
    }

    /* Loading - VHS tracking style */
    .loading {
      display: none;
      text-align: center;
      padding: 60px 20px;
      position: relative;
    }

    .loading.visible {
      display: block;
      animation: fadeInUp 0.4s ease;
    }

    .loading::before {
      content: 'TRACKING...';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #ffff00;
      font-family: 'VT323', monospace;
      font-size: 1rem;
      letter-spacing: 3px;
      animation: blink 0.5s infinite;
    }

    .spinner {
      width: 80px;
      height: 80px;
      border: 6px solid #333;
      border-top-color: #ff0000;
      border-right-color: #00ff00;
      border-bottom-color: #0000ff;
      animation: spin 0.5s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-title {
      font-size: 1.6rem;
      font-weight: 400;
      margin-bottom: 12px;
      color: #00ffff;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: glitch 0.5s infinite;
    }

    .loading-subtitle {
      color: #ff00ff;
      font-size: 1.2rem;
      margin-bottom: 24px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .loading-progress {
      max-width: 300px;
      margin: 0 auto;
    }

    .progress-bar {
      height: 8px;
      background: #333;
      overflow: hidden;
      margin-bottom: 16px;
      border: 2px solid #fff;
    }

    .progress-fill {
      height: 100%;
      background: repeating-linear-gradient(90deg,
          #ff0000 0px,
          #ff0000 10px,
          #ffff00 10px,
          #ffff00 20px,
          #00ff00 20px,
          #00ff00 30px,
          #00ffff 30px,
          #00ffff 40px,
          #ff00ff 40px,
          #ff00ff 50px);
      animation: progressPulse 1s ease-in-out infinite, progressScroll 0.5s linear infinite;
      width: 60%;
    }

    @keyframes progressPulse {

      0%,
      100% {
        width: 30%;
      }

      50% {
        width: 90%;
      }
    }

    @keyframes progressScroll {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 50px 0;
      }
    }

    .loading-tips {
      color: #666;
      font-size: 1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Result */
    .result {
      display: none;
      text-align: center;
    }

    .result.visible {
      display: block;
      animation: fadeInUp 0.5s ease;
    }

    .result-image-container {
      position: relative;
      display: inline-block;
      margin-bottom: 24px;
    }

    .result img {
      max-width: 100%;
      border: 6px solid #fff;
      box-shadow:
        0 0 40px rgba(255, 0, 255, 0.5),
        inset 0 0 60px rgba(0, 255, 255, 0.1);
      transition: transform 0.3s ease;
      filter: contrast(1.05) saturate(1.1);
    }

    .result img:hover {
      transform: scale(1.02) rotate(1deg);
      filter: contrast(1.1) saturate(1.3);
    }

    .result-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-download,
    .btn-share,
    .btn-another {
      padding: 14px 28px;
      font-size: 1.1rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: 3px solid #000;
    }

    .btn-download {
      background: #00ff00;
      color: #000;
      box-shadow: 4px 4px 0 #000;
    }

    .btn-download:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
      background: #00ffff;
    }

    .btn-share {
      background: #ff00ff;
      color: #fff;
      box-shadow: 4px 4px 0 #000;
    }

    .btn-share:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
      background: #ffff00;
      color: #000;
    }

    .btn-another {
      background: #000;
      color: #fff;
      border-color: #fff;
      box-shadow: 4px 4px 0 #ff0000;
    }

    .btn-another:hover {
      background: #ff0000;
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #fff;
    }

    /* Watermark Removal Promo */
    .watermark-promo {
      margin-top: 20px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #1a0a2e 0%, #2a1a4e 50%, #1a0a2e 100%);
      border: 3px solid #ffd700;
      border-radius: 0;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 30px rgba(255, 215, 0, 0.1);
      animation: promoGlow 2s ease-in-out infinite alternate;
    }

    @keyframes promoGlow {
      from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 30px rgba(255, 215, 0, 0.1); }
      to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), inset 0 0 40px rgba(255, 215, 0, 0.2); }
    }

    .watermark-promo-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .promo-icon {
      font-size: 1.8rem;
      animation: sparkle 1s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(10deg); }
    }

    .promo-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .promo-text strong {
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .promo-price {
      color: #ffd700;
      font-size: 1.3rem;
      font-weight: bold;
      font-family: 'VT323', monospace;
    }

    .btn-remove-watermark {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
      color: #000;
      border: 3px solid #fff;
      border-radius: 0;
      font-family: 'VT323', monospace;
      letter-spacing: 1px;
      transition: all 0.2s ease;
      box-shadow: 4px 4px 0 #000;
    }

    .btn-remove-watermark:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
      background: linear-gradient(135deg, #ffea00 0%, #ffd700 100%);
    }

    .watermark-promo.hidden {
      display: none;
    }

    .btn-icon {
      width: 18px;
      height: 18px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #00ff00;
      color: #000;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 400;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      border: 3px solid #000;
      box-shadow: 4px 4px 0 #000;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Error - MAXIMUM ALARM */
    .error {
      background: #ff0000;
      border: 4px solid #ffff00;
      padding: 16px;
      margin-bottom: 16px;
      display: none;
      animation: shake 0.3s ease, blink 0.2s infinite;
      font-family: 'VT323', monospace;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #ffff00;
      text-align: center;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0) rotate(0);
      }

      20%,
      60% {
        transform: translateX(-10px) rotate(-2deg);
      }

      40%,
      80% {
        transform: translateX(10px) rotate(2deg);
      }
    }

    .error.visible {
      display: block;
    }

    /* Footer - ironic disclaimer */
    footer {
      text-align: center;
      padding: 40px 20px;
      color: #333;
      font-size: 1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-top: 2px dashed #333;
      margin-top: 40px;
    }

    footer::before {
      content: '[ DISCLAIMER ]';
      display: block;
      color: #ff0000;
      margin-bottom: 8px;
    }

    /* Debug toggle - hacker style (admin only) */
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #000;
      padding: 8px 12px;
      font-size: 0.9rem;
      color: #00ff00;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      border: 2px solid #00ff00;
      text-transform: uppercase;
      display: none;
      /* Hidden until admin logs in */
    }

    .debug-toggle:hover {
      background: #00ff00;
      color: #000;
    }

    /* Admin Panel Styles - CLASSIFIED */
    /* Camera Button */
    .btn-camera {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px 20px;
      background: #00ff00;
      color: #000;
      border: 2px solid #000;
      font-family: 'VT323', monospace;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-camera:hover {
      background: #ffff00;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #000;
    }

    .btn-camera:active {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 #000;
    }

    .btn-camera svg {
      width: 20px;
      height: 20px;
      stroke: #000;
    }

    /* Camera Overlay and Modal */
    .camera-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.98);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .camera-overlay.visible {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .camera-modal {
      background: #000;
      border: 4px solid #00ff00;
      padding: 20px;
      width: 100%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 0 60px rgba(0, 255, 0, 0.3);
    }

    .camera-modal h2 {
      color: #00ff00;
      text-align: center;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 16px;
      font-size: 1.3rem;
    }

    #cameraVideo {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
      background: #111;
      border: 2px solid #00ff00;
      border-radius: 4px;
      display: block;
      margin-bottom: 16px;
    }

    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .btn-capture {
      background: #00ff00;
      color: #000;
      border: 2px solid #000;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      min-width: 200px;
    }

    .btn-capture:hover {
      background: #ffff00;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #000;
    }

    .btn-capture:active {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 #000;
    }

    .camera-hint {
      color: #666;
      font-size: 0.9rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      text-align: center;
      margin: 0;
    }

    .btn-camera-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: #00ff00;
      cursor: pointer;
      font-size: 2rem;
      line-height: 1;
      padding: 4px;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      z-index: 10;
    }

    .btn-camera-close:hover {
      color: #ff0000;
      transform: rotate(90deg);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .camera-modal {
        padding: 16px;
      }

      .camera-modal h2 {
        font-size: 1.1rem;
        margin-bottom: 12px;
      }

      #cameraVideo {
        max-height: 50vh;
        margin-bottom: 12px;
      }

      .btn-capture {
        min-width: 160px;
        padding: 10px 20px;
        font-size: 0.9rem;
      }

      .camera-hint {
        font-size: 0.8rem;
      }
    }

    .admin-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .admin-overlay.visible {
      display: flex;
    }

    .admin-modal {
      background: #000;
      border: 4px solid #ffff00;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 60px rgba(255, 255, 0, 0.3);
    }

    .admin-modal h2 {
      margin-bottom: 20px;
      color: #ffff00;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 1.5rem;
    }

    .admin-modal h2 svg {
      width: 24px;
      height: 24px;
      stroke: #ffff00;
    }

    .admin-login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .admin-login-form input {
      background: #111;
      border: 2px solid #ffff00;
      padding: 12px 16px;
      color: #00ff00;
      font-size: 1.1rem;
      font-family: 'VT323', monospace;
    }

    .admin-login-form input:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
    }

    .admin-login-form input::placeholder {
      color: #666;
    }

    .btn-admin-login {
      background: #ffff00;
      color: #000;
      border: none;
      padding: 12px 20px;
      font-size: 1.1rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .btn-admin-login:hover {
      background: #00ff00;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }

    .btn-admin-login:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .admin-error {
      color: #ff0000;
      font-size: 1rem;
      padding: 10px;
      background: rgba(255, 0, 0, 0.2);
      border: 2px solid #ff0000;
      display: none;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .admin-error.visible {
      display: block;
    }

    .btn-admin-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: #ffff00;
      cursor: pointer;
      font-size: 2rem;
      line-height: 1;
      padding: 4px;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
    }

    .btn-admin-close:hover {
      color: #ff0000;
      transform: rotate(90deg);
    }

    /* Admin Debug Panel */
    .admin-panel {
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      width: 360px;
      max-height: calc(100vh - 100px);
      background: #000;
      border: 3px solid #ffff00;
      padding: 20px;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 0 0 40px rgba(255, 255, 0, 0.2);
    }

    .admin-panel.visible {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .admin-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px dashed #ffff00;
    }

    .admin-panel-title {
      color: #ffff00;
      font-weight: 400;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .admin-panel-title svg {
      width: 18px;
      height: 18px;
      stroke: #ffff00;
    }

    .btn-admin-logout {
      background: #ff0000;
      color: #fff;
      border: none;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .btn-admin-logout:hover {
      background: #ff00ff;
    }

    .admin-section {
      margin-bottom: 16px;
    }

    .admin-section-title {
      color: #00ffff;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      font-family: 'VT323', monospace;
    }

    .admin-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 0.95rem;
      border-bottom: 1px solid #222;
      font-family: 'VT323', monospace;
    }

    .admin-stat-label {
      color: #666;
    }

    .admin-stat-value {
      color: #fff;
    }

    .admin-stat-value.good {
      color: #00ff00;
    }

    .admin-stat-value.warn {
      color: #ffff00;
    }

    .admin-stat-value.bad {
      color: #ff0000;
    }

    .admin-badge {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #ffff00;
      color: #000;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 400;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: 2px solid #000;
    }

    .admin-badge:hover {
      background: #00ff00;
    }

    .admin-badge.visible {
      display: flex;
    }

    .admin-badge svg {
      width: 14px;
      height: 14px;
      stroke: #000;
    }

    .btn-refresh-debug {
      width: 100%;
      background: #111;
      border: 2px solid #ffff00;
      color: #ffff00;
      padding: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 12px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-refresh-debug:hover {
      background: #ffff00;
      color: #000;
    }

    /* Generation debug info */
    .generation-debug {
      background: rgba(0, 255, 0, 0.1);
      border: 2px solid #00ff00;
      padding: 12px;
      margin-top: 16px;
      font-size: 0.95rem;
    }

    .generation-debug-title {
      color: #00ff00;
      font-weight: 400;
      margin-bottom: 8px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    @media (max-width: 640px) {
      .admin-panel {
        right: 10px;
        left: 10px;
        width: auto;
        top: 70px;
        max-height: calc(100vh - 90px);
      }

      .admin-badge {
        top: 10px;
        left: 10px;
      }

      .admin-modal {
        margin: 16px;
        padding: 24px;
      }
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .container {
        padding: 24px 16px;
      }

      h1 {
        font-size: 1.4rem;
        letter-spacing: 2px;
      }

      .subtitle {
        font-size: 1.1rem;
        letter-spacing: 1px;
        padding: 6px 12px;
      }

      .card {
        padding: 20px 16px;
        box-shadow: 4px 4px 0 #ff0000;
      }

      .card:hover {
        transform: none;
      }

      .gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .gallery-item {
        border-width: 2px;
      }

      .gallery-item:hover {
        transform: none;
        box-shadow: none;
      }

      .gallery-item:active {
        transform: scale(0.95);
      }

      .upload-zone {
        padding: 32px 16px;
      }

      .upload-zone:hover {
        transform: none;
      }

      .btn-generate {
        padding: 16px;
        font-size: 1.2rem;
        letter-spacing: 1px;
        box-shadow: 4px 4px 0 #000;
      }

      .btn-generate:hover:not(:disabled) {
        transform: none;
        box-shadow: 4px 4px 0 #ff0000;
      }

      .result-actions {
        flex-direction: column;
        gap: 10px;
      }

      .btn-download,
      .btn-share,
      .btn-another {
        width: 100%;
        justify-content: center;
        padding: 14px 20px;
      }

      .loading {
        padding: 40px 16px;
      }

      .spinner {
        width: 60px;
        height: 60px;
      }

      .loading-title {
        font-size: 1.2rem;
      }

      footer {
        padding: 32px 16px;
        font-size: 0.9rem;
      }

      .debug-toggle {
        bottom: 16px;
        right: 16px;
        font-size: 0.8rem;
        padding: 6px 10px;
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) {
      .gallery-item:hover {
        transform: none;
        border-color: #333;
        box-shadow: none;
        filter: grayscale(30%) contrast(1.2);
      }

      .gallery-item:hover::before {
        opacity: 0;
      }

      .gallery-item:hover img {
        transform: none;
      }

      .gallery-item.selected {
        transform: none;
      }
    }

    /* Animate in helper */
    .animate-in {
      animation: fadeInUp 0.5s ease;
    }

    /* Auth Header Bar */
    .auth-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 0 4px;
    }

    /* Google Sign In Button */
    .btn-google {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      color: #000;
      border: 3px solid #000;
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 4px 4px 0 #000;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-google:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
      background: #00ff00;
    }

    .btn-google:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    .btn-google svg {
      width: 18px;
      height: 18px;
    }

    /* User Profile Section */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border: 3px solid #00ff00;
      object-fit: cover;
      transition: all 0.2s ease;
      filter: contrast(1.2);
    }

    .user-avatar:hover {
      border-color: #ff00ff;
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .user-name {
      color: #fff;
      font-size: 1rem;
      font-weight: 400;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .user-tier {
      font-size: 0.9rem;
      padding: 2px 8px;
      margin-top: 2px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .user-tier.free {
      background: #ff0000;
      color: #fff;
      border: 2px solid #ff0000;
    }

    .user-tier.base {
      background: #ffff00;
      color: #000;
      border: 2px solid #000;
    }

    .btn-logout {
      background: #000;
      border: 2px solid #ff0000;
      color: #ff0000;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
    }

    .btn-logout:hover {
      background: #ff0000;
      color: #000;
    }

    /* Usage Counter */
    .usage-counter {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #000;
      padding: 8px 14px;
      border: 2px solid #00ffff;
      font-family: 'VT323', monospace;
    }

    .usage-counter-text {
      color: #00ffff;
      font-size: 0.95rem;
      text-transform: uppercase;
    }

    .usage-counter-value {
      color: #ff0000;
      font-weight: 400;
    }

    .usage-counter-value.unlimited {
      color: #00ff00;
    }

    /* Upgrade Button */
    .btn-upgrade {
      background: #ffff00;
      color: #000;
      border: 3px solid #000;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 3px 3px 0 #000;
    }

    .btn-upgrade:hover {
      background: #00ff00;
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 #000;
    }

    .btn-upgrade:active {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 #000;
    }

    .btn-upgrade svg {
      width: 14px;
      height: 14px;
      stroke: #000;
    }

    /* Auth loading state */
    .auth-loading {
      color: #ffff00;
      font-size: 1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      animation: blink 0.5s infinite;
    }

    /* Hide elements based on auth state */
    .auth-hidden {
      display: none !important;
    }

    /* Full-page auth overlay */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    /* VHS tracking bars on auth overlay */
    .auth-overlay::before {
      content: '';
      position: absolute;
      top: 30%;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(180deg,
          transparent 0%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 100%);
      animation: trackingBar 3s ease-in-out infinite;
    }

    @keyframes trackingBar {
      0% {
        top: -60px;
      }

      100% {
        top: 100%;
      }
    }

    .auth-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .auth-card {
      background: #000;
      border: 4px solid #fff;
      padding: 48px;
      max-width: 460px;
      width: 90%;
      text-align: center;
      box-shadow:
        12px 12px 0 #ff0000,
        -6px -6px 0 #00ffff;
      position: relative;
    }

    .auth-card::before {
      content: 'SYSTEM ACCESS';
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff0000;
      color: #fff;
      padding: 4px 16px;
      font-family: 'VT323', monospace;
      font-size: 1rem;
      letter-spacing: 3px;
      border: 2px solid #fff;
    }

    .auth-card h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      color: #fff;
      font-family: 'Press Start 2P', 'VT323', monospace;
      animation: glitch 0.5s infinite;
    }

    .auth-card .subtitle {
      color: #00ffff;
      font-size: 1.3rem;
      margin-bottom: 32px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: none;
      padding: 0;
      background: none;
    }

    .auth-card .btn-google-large {
      width: 100%;
      padding: 16px 24px;
      font-size: 1.2rem;
      background: #fff;
      color: #000;
      border: 3px solid #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-weight: 400;
      transition: all 0.2s ease;
      box-shadow: 6px 6px 0 #000;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .auth-card .btn-google-large:hover {
      background: #00ff00;
      transform: translate(-3px, -3px);
      box-shadow: 9px 9px 0 #000;
    }

    .auth-card .btn-google-large:active {
      transform: translate(2px, 2px);
      box-shadow: 4px 4px 0 #000;
    }

    .auth-card .btn-google-large svg {
      width: 24px;
      height: 24px;
    }

    .auth-card .btn-continue-anon {
      width: 100%;
      padding: 12px 24px;
      font-size: 1rem;
      background: transparent;
      color: #888;
      border: 2px solid #444;
      cursor: pointer;
      margin-top: 12px;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s ease;
    }

    .auth-card .btn-continue-anon:hover {
      color: #fff;
      border-color: #666;
      background: #222;
    }

    .auth-card .anon-limit-note {
      margin-top: 16px;
      color: #666;
      font-size: 0.85rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .auth-card .auth-footer {
      margin-top: 24px;
      color: #666;
      font-size: 1rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .auth-loading-overlay {
      color: #ffff00;
      font-size: 1.3rem;
      font-family: 'VT323', monospace;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: blink 0.3s infinite;
    }

    /* Mobile auth bar */
    @media (max-width: 640px) {
      .auth-bar {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }

      .user-profile {
        flex-direction: column;
        text-align: center;
      }

      .user-info {
        align-items: center;
      }

      .btn-google {
        padding: 10px 16px;
        font-size: 0.9rem;
      }

      .usage-counter {
        width: 100%;
        justify-content: center;
      }

      .auth-card {
        padding: 32px 24px;
        box-shadow:
          6px 6px 0 #ff0000,
          -3px -3px 0 #00ffff;
      }

      .auth-card h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>

<body>
  <!-- Full-page auth overlay - shown until user signs in -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
      <h1>PIMP MY EPSTEIN</h1>
      <p class="subtitle">HANG OUT WITH EPSTEIN, USING AI</p>
      <div id="authOverlayContent">
        <p class="auth-loading-overlay">INITIALIZING SYSTEM...</p>
      </div>
      <p class="auth-footer">SIGN IN TO PROCEED</p>
    </div>
  </div>

  <div class="container">
    <!-- Auth Bar -->
    <div class="auth-bar fade-in-up" id="authBar">
      <!-- Loading state (shown while checking auth) -->
      <span class="auth-loading" id="authLoading">INITIALIZING...</span>

      <!-- Logged out state -->
      <button class="btn-google auth-hidden" id="googleSignInBtn">
        <svg viewBox="0 0 24 24">
          <path fill="#4285F4"
            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
          <path fill="#34A853"
            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
          <path fill="#FBBC05"
            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
          <path fill="#EA4335"
            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
        </svg>
        SIGN IN
      </button>

      <!-- Logged in state -->
      <div class="user-profile auth-hidden" id="userProfile">
        <div class="usage-counter" id="usageCounter">
          <span class="usage-counter-text">Generations:</span>
          <span class="usage-counter-value" id="usageCounterValue">0 / 3</span>
        </div>
        <button class="btn-upgrade auth-hidden" id="upgradeBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
            stroke-linejoin="round">
            <polygon
              points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          </svg>
          UPGRADE
        </button>
        <div class="user-info">
          <span class="user-name" id="userName">User</span>
          <span class="user-tier free" id="userTier">Free</span>
        </div>
        <img class="user-avatar" id="userAvatar" src="" alt="User avatar">
        <button class="btn-logout" id="logoutBtn">LOGOUT</button>
      </div>
    </div>

    <header class="fade-in-up">
      <span class="rec-indicator" id="recIndicator">REC </span>
      <h1>PIMP MY EPSTEIN</h1>
      <p class="subtitle">HANG OUT WITH EPSTEIN, USING AI</p>
      <div class="usage-badge" id="usageBadge">1 SWAP REMAINING</div>
      <div class="parody-disclaimer">PARODY SITE  MEDIA LITERACY DEMO. MANIPULATED IMAGES ARE USED TO SHOW HOW EASY
        FAKES CAN BE.</div>
    </header>

    <div id="mainContent">
      <div class="error" id="error"></div>

      <!-- Step 1: Pick an Epstein photo -->
      <div class="card fade-in-up delay-1">
        <div class="card-title">1. SELECT YOUR EPSCENE</div>
        <div class="gallery" id="gallery">
          <!-- Photos loaded dynamically -->
        </div>
        <button class="btn-random" id="randomBtn">RANDOMIZE</button>
      </div>

      <!-- Step 2: Upload your face -->
      <div class="card fade-in-up delay-2">
        <div class="card-title">2. UPLOAD YOUR FACE</div>
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <polyline points="21 15 16 10 5 21" />
            </svg>
          </div>
          <div class="upload-text">DROP FILE OR CLICK TO UPLOAD</div>
          <div class="upload-hint">CLEAR FACE REQUIRED</div>
          <div class="upload-hint">JPG, PNG, WebP | Max 10MB | Min 256x256px</div>
          <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp,image/heic,image/heif,.heic,.heif">
        </div>
        <div class="preview-container" id="previewContainer">
          <img class="preview-img" id="previewImg" alt="Your photo">
        </div>
        <button class="btn-camera" id="cameraBtn" title="Open camera">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
            <circle cx="12" cy="13" r="4" />
          </svg>
          TAKE PHOTO
        </button>
      </div>

      <!-- Generate Buttons - Dual Quick/Premium -->
      <div class="generate-buttons fade-in-up delay-3">
        <button class="btn-generate btn-quick" id="generateQuickBtn" disabled>
          <span> QUICK (EXPERIMENTAL)</span>
          <small id="quickRemaining">5 left</small>
        </button>
        <button class="btn-generate btn-premium" id="generatePremiumBtn" disabled>
          <span> PREMIUM</span>
          <small id="premiumRemaining">1 left</small>
        </button>
      </div>
    </div>

    <!-- Loading state -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p class="loading-title" id="loadingTitle">PROCESSING...</p>
      <p class="loading-subtitle" id="loadingSubtitle">NEURAL NETWORK ACTIVE</p>
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        <p class="loading-tips" id="loadingTips">ESTIMATED TIME: 15-30 SEC</p>
      </div>
    </div>

    <!-- Result -->
    <div class="card result" id="result">
      <div class="result-image-container">
        <img id="resultImage" alt="Your pimped Epstein">
      </div>
      <div class="result-actions">
        <button class="btn-download" id="downloadBtn">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          SAVE
        </button>
        <button class="btn-share" id="shareBtn">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3" />
            <circle cx="6" cy="12" r="3" />
            <circle cx="18" cy="19" r="3" />
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
          </svg>
          SHARE
        </button>
        <button class="btn-another" id="anotherBtn">GO AGAIN</button>
      </div>

      <!-- Watermark Removal Promo - shown for free/anonymous users -->
      <div class="watermark-promo" id="watermarkPromo">
        <div class="watermark-promo-content">
          <span class="promo-icon"></span>
          <div class="promo-text">
            <strong>Remove Watermark + Get 1 Premium Generation</strong>
            <span class="promo-price">Just $2.99</span>
          </div>
          <button class="btn-remove-watermark" id="removeWatermarkBtn">UNLOCK NOW</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast">LINK COPIED</div>

  <footer class="fade-in-up delay-4">
    <p>FOR ENTERTAINMENT PURPOSES ONLY - NOT REAL - FAKE NEWS</p>
  </footer>

  <div class="debug-toggle" id="debugToggle">Debug: OFF</div>

  <!-- Admin Badge (shown when logged in as admin) -->
  <div class="admin-badge" id="adminBadge">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    </svg>
    ADMIN MODE
  </div>

  <!-- Admin Debug Panel -->
  <div class="admin-panel" id="adminPanel">
    <div class="admin-panel-header">
      <div class="admin-panel-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
        Debug Panel
      </div>
      <button class="btn-admin-logout" id="adminLogoutBtn">Logout</button>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Server Status</div>
      <div id="adminServerStats">
        <div class="admin-stat-row">
          <span class="admin-stat-label">Loading...</span>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Configuration</div>
      <div id="adminConfigStats">
        <div class="admin-stat-row">
          <span class="admin-stat-label">Loading...</span>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Usage Stats</div>
      <div id="adminUsageStats">
        <div class="admin-stat-row">
          <span class="admin-stat-label">Loading...</span>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Supabase</div>
      <div id="adminSupabaseStats">
        <div class="admin-stat-row">
          <span class="admin-stat-label">Loading...</span>
        </div>
      </div>
    </div>

    <div class="admin-section" id="lastGenerationDebug" style="display: none;">
      <div class="admin-section-title">Last Generation</div>
      <div id="adminGenerationStats"></div>
    </div>

    <button class="btn-refresh-debug" id="refreshDebugBtn">Refresh Debug Info</button>
  </div>

  <!-- Camera Capture Modal -->
  <div class="camera-overlay" id="cameraOverlay">
    <div class="camera-modal">
      <button class="btn-camera-close" id="cameraCancelBtn">&times;</button>
      <h2>CAMERA CAPTURE</h2>
      <video id="cameraVideo" autoplay playsinline muted></video>
      <canvas id="captureCanvas" style="display: none;"></canvas>
      <div class="camera-controls">
        <button class="btn-capture" id="captureBtn">CAPTURE PHOTO</button>
        <p class="camera-hint">Position your face clearly in the center</p>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div class="admin-overlay" id="adminOverlay">
    <div class="admin-modal" style="position: relative;">
      <button class="btn-admin-close" id="adminCloseBtn">&times;</button>
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
        Admin Access
      </h2>
      <form class="admin-login-form" id="adminLoginForm">
        <input type="password" id="adminPasswordInput" placeholder="Enter admin password" autocomplete="off">
        <div class="admin-error" id="adminLoginError"></div>
        <button type="submit" class="btn-admin-login" id="adminLoginBtn">Login</button>
      </form>
      <p style="color: #71717a; font-size: 0.8rem; margin-top: 16px; text-align: center;">
        Access via Ctrl+Shift+A or ?admin=PASSWORD
      </p>
    </div>
  </div>

  <script>
    // =====================================================
    // SUPABASE CONFIGURATION
    // =====================================================
    // Config loaded from server at runtime
    let SUPABASE_URL = '';
    let SUPABASE_ANON_KEY = '';

    // Supabase client (initialized after config loads)
    // Note: Using 'supabaseClient' to avoid conflict with window.supabase from CDN
    let supabaseClient = null;

    // Load configuration from server
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        SUPABASE_URL = config.supabase?.url || '';
        SUPABASE_ANON_KEY = config.supabase?.anonKey || '';

        // Initialize Supabase client if credentials are available
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
          console.warn('Supabase not configured - auth features disabled');
        }
      } catch (err) {
        console.error('Failed to load config:', err);
      }
    }

    // =====================================================
    // STATE
    // =====================================================
    let selectedPhoto = null;
    let userFile = null;
    let usageCount = parseInt(localStorage.getItem('epsteinswap_usage') || '0');
    const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
    let debugMode = false;
    let debugModeSource = 'none'; // admin | dev | none
    let devDebugAllowed = false;
    let devDebugEnabled = false;
    let loadingInterval = null;
    const MAX_USAGE = 6;        // Free registered users: 5 quick + 1 premium = 6 total
    const ANON_MAX_USAGE = 3;   // Anonymous users: 3 quick only
    const MAX_ANON_USAGE = 3;   // Anonymous users: 3 quick only

    // Auth state
    let currentUser = null;
    let currentSession = null;
    let userTier = 'free'; // 'anonymous', 'free', or 'base'
    let serverUsageCount = 0;

    // Admin state
    // SECURITY: Admin token is now stored in httpOnly cookie (not accessible via JavaScript)
    // We track isAdmin state locally but verify with server on each admin action
    let isAdminLoggedIn = false;
    let adminPanelVisible = false;
    let lastGenerationDebugInfo = null;

    // Track last generation for watermark removal flow
    let lastGenerationId = null;
    let lastViewToken = null;

    // Loading messages for better UX - MDE style
    const loadingMessages = [
      { title: 'ANALYZING BIOMETRICS...', subtitle: 'SCANNING FACIAL STRUCTURE', tip: 'NEURAL NETWORK PROCESSING' },
      { title: 'EXECUTING FACE SWAP...', subtitle: 'INJECTING YOUR IDENTITY', tip: 'ESTIMATED: 15-30 SECONDS' },
      { title: 'ALMOST COMPLETE...', subtitle: 'FINALIZING INJECTION', tip: 'STANDBY FOR OUTPUT' },
      { title: 'RENDERING OUTPUT...', subtitle: 'GENERATING FINAL IMAGE', tip: 'TRANSMISSION IMMINENT' }
    ];

    // =====================================================
    // ELEMENTS
    // =====================================================
    const gallery = document.getElementById('gallery');
    const randomBtn = document.getElementById('randomBtn');
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImg = document.getElementById('previewImg');
    const generateQuickBtn = document.getElementById('generateQuickBtn');
    const generatePremiumBtn = document.getElementById('generatePremiumBtn');
    const quickRemaining = document.getElementById('quickRemaining');
    const premiumRemaining = document.getElementById('premiumRemaining');
    const mainContent = document.getElementById('mainContent');
    const loading = document.getElementById('loading');
    const loadingTitle = document.getElementById('loadingTitle');
    const loadingSubtitle = document.getElementById('loadingSubtitle');
    const loadingTips = document.getElementById('loadingTips');
    const result = document.getElementById('result');
    const resultImage = document.getElementById('resultImage');
    const downloadBtn = document.getElementById('downloadBtn');
    const shareBtn = document.getElementById('shareBtn');
    const anotherBtn = document.getElementById('anotherBtn');
    const watermarkPromo = document.getElementById('watermarkPromo');
    const removeWatermarkBtn = document.getElementById('removeWatermarkBtn');
    const errorDiv = document.getElementById('error');
    const usageBadge = document.getElementById('usageBadge');
    const debugToggle = document.getElementById('debugToggle');
    const toast = document.getElementById('toast');

    // Auth elements
    const authLoading = document.getElementById('authLoading');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const userProfile = document.getElementById('userProfile');
    const authOverlay = document.getElementById('authOverlay');
    const authOverlayContent = document.getElementById('authOverlayContent');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userTierBadge = document.getElementById('userTier');
    const usageCounter = document.getElementById('usageCounter');
    const usageCounterValue = document.getElementById('usageCounterValue');
    const upgradeBtn = document.getElementById('upgradeBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Admin elements
    const adminBadge = document.getElementById('adminBadge');
    const adminPanel = document.getElementById('adminPanel');
    const adminOverlay = document.getElementById('adminOverlay');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const adminLoginError = document.getElementById('adminLoginError');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminCloseBtn = document.getElementById('adminCloseBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const refreshDebugBtn = document.getElementById('refreshDebugBtn');

    // Epstein photos (loaded from server)
    let epsteinPhotos = [];

    // =====================================================
    // AUTH FUNCTIONS
    // =====================================================

    // Get current JWT token for API requests
    function getAuthToken() {
      return currentSession?.access_token || null;
    }

    // Helper to make authenticated API requests
    async function fetchWithAuth(url, options = {}) {
      const token = getAuthToken();
      const headers = {
        ...options.headers,
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      return fetch(url, {
        ...options,
        headers
      });
    }

    async function fetchDevDebugStatus() {
      if (!isLocalhost) return;

      try {
        const res = await fetch('/api/dev/debug', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        devDebugAllowed = data.allowed === true;
        devDebugEnabled = data.enabled === true;
      } catch (err) {
        devDebugAllowed = false;
        devDebugEnabled = false;
      }
    }

    async function setDevDebug(enabled) {
      if (!isLocalhost) return { allowed: false, enabled: false };

      const res = await fetch('/api/dev/debug', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ enabled })
      });

      if (!res.ok) {
        return { allowed: false, enabled: false };
      }

      return res.json();
    }

    function setDebugMode(enabled, source) {
      debugMode = enabled;
      debugModeSource = source;
      updateDebugToggle();
      updateUsageBadge();
    }

    function updateDebugVisibility() {
      debugToggle.style.display = (isAdminLoggedIn || devDebugAllowed) ? 'block' : 'none';
    }

    // Sign in with Google
    async function signInWithGoogle() {
      if (!supabaseClient) {
        showError('Authentication is not configured');
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin
          }
        });

        if (error) {
          console.error('Google sign-in error:', error);
          showError('Failed to sign in with Google');
        }
      } catch (err) {
        console.error('Sign-in error:', err);
        showError('Failed to sign in');
      }
    }

    // Sign out
    async function signOut() {
      if (!supabaseClient) {
        return;
      }

      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error('Sign-out error:', error);
        }
        // State will be updated by auth state listener
      } catch (err) {
        console.error('Sign-out error:', err);
      }
    }

    // Fetch user usage data from server
    async function fetchUserUsage() {
      if (!currentUser) return;

      try {
        const res = await fetchWithAuth('/api/me');
        if (res.ok) {
          const data = await res.json();
          serverUsageCount = data.usage?.used || 0;
          userTier = data.usage?.tier || 'free';

          // Update quick/premium remaining counts for button display
          if (typeof data.usage?.quickRemaining === 'number') {
            quickRemainingCount = Math.max(0, data.usage.quickRemaining);
          }
          if (typeof data.usage?.premiumRemaining === 'number') {
            premiumRemainingCount = Math.max(0, data.usage.premiumRemaining);
          }

          updateRemainingDisplay();
          updateAuthUI();
        }
      } catch (err) {
        console.error('Failed to fetch usage:', err);
        // Fall back to local storage usage
      }
    }

    async function fetchAnonymousUsage() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data?.usage) return;

        if (typeof data.usage.quickRemaining === 'number') {
          quickRemainingCount = Math.max(0, data.usage.quickRemaining);
        }
        if (typeof data.usage.premiumRemaining === 'number') {
          premiumRemainingCount = Math.max(0, data.usage.premiumRemaining);
        }

        const used = (data.usage.quickUsed || 0) + (data.usage.premiumUsed || 0);
        usageCount = used;
        localStorage.setItem('epsteinswap_usage', usageCount.toString());
        updateRemainingDisplay();
        updateUsageBadge();
      } catch (err) {
        // Ignore anonymous usage fetch errors
      }
    }

    // Update UI based on auth state
    function updateAuthUI() {
      // Hide loading
      authLoading.classList.add('auth-hidden');

      if (currentUser) {
        // Hide auth overlay - user is logged in
        authOverlay.classList.add('hidden');

        // Show logged in state
        googleSignInBtn.classList.add('auth-hidden');
        userProfile.classList.remove('auth-hidden');

        // Set user info
        userName.textContent = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User';

        // Set avatar
        const avatarUrl = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        if (avatarUrl) {
          userAvatar.src = avatarUrl;
          userAvatar.style.display = 'block';
        } else {
          userAvatar.style.display = 'none';
        }

        // Set tier badge
        if (userTier === 'base') {
          userTierBadge.textContent = 'Base';
          userTierBadge.classList.remove('free');
          userTierBadge.classList.add('base');
          upgradeBtn.classList.add('auth-hidden');
          usageCounterValue.textContent = 'UNLIMITED';
          usageCounterValue.classList.add('unlimited');
        } else {
          userTierBadge.textContent = 'Free';
          userTierBadge.classList.remove('base');
          userTierBadge.classList.add('free');
          upgradeBtn.classList.remove('auth-hidden');
          usageCounterValue.textContent = `${serverUsageCount} / ${MAX_USAGE}`;
          usageCounterValue.classList.remove('unlimited');
        }

        // Hide legacy usage badge for logged-in users (they have usageCounter in nav)
        usageBadge.style.display = 'none';

      } else {
        // Show auth overlay with Google sign-in button
        authOverlay.classList.remove('hidden');
        authOverlayContent.innerHTML = `
          <button class="btn-google-large" id="overlayGoogleBtn">
            <svg viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
          </button>
          <button class="btn-continue-anon" id="overlayContinueBtn">
            Continue without account
          </button>
          <p class="anon-limit-note">3 free generations (IP limited)</p>
        `;
        document.getElementById('overlayGoogleBtn').addEventListener('click', signInWithGoogle);
        document.getElementById('overlayContinueBtn').addEventListener('click', () => {
          authOverlay.classList.add('hidden');
          userTier = 'anonymous';
          fetchAnonymousUsage();
        });

        // Also update the auth bar (hidden behind overlay)
        googleSignInBtn.classList.remove('auth-hidden');
        userProfile.classList.add('auth-hidden');

        // Show usage badge for anonymous users and update it
        usageBadge.style.display = '';
        updateUsageBadge();
        fetchAnonymousUsage();
      }
    }

    // Initialize auth
    async function initAuth() {
      // Skip if Supabase is not configured
      if (!supabaseClient) {
        console.warn('Supabase not available - skipping auth initialization');
        updateAuthUI();
        return;
      }

      // Check for existing session
      const { data: { session }, error } = await supabaseClient.auth.getSession();

      if (session) {
        currentSession = session;
        currentUser = session.user;
        await fetchUserUsage();
      }

      updateAuthUI();

      // Listen for auth changes
      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log('Auth state changed:', event);
        currentSession = session;
        currentUser = session?.user || null;

        if (currentUser) {
          await fetchUserUsage();

          // Check if user just signed in to complete watermark removal flow
          const pendingWatermarkRemoval = sessionStorage.getItem('pendingWatermarkRemoval');
          if (pendingWatermarkRemoval === 'true' && event === 'SIGNED_IN') {
            sessionStorage.removeItem('pendingWatermarkRemoval');

            // Restore UI state from stored photos
            const pendingUserPhoto = sessionStorage.getItem('pendingUserPhoto');
            const pendingEpsteinPhoto = sessionStorage.getItem('pendingEpsteinPhoto');

            if (pendingUserPhoto) {
              previewImg.src = pendingUserPhoto;
              previewContainer.classList.add('visible');
            }
            if (pendingEpsteinPhoto) {
              selectedPhoto = pendingEpsteinPhoto;
              gallery.querySelectorAll('.gallery-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.path === pendingEpsteinPhoto) {
                  item.classList.add('selected');
                }
              });
            }

            // Auto-trigger watermark removal checkout
            showToast('CONTINUING TO CHECKOUT...');
            setTimeout(() => {
              if (removeWatermarkBtn) {
                removeWatermarkBtn.click();
              }
            }, 1000);
          }
        } else {
          serverUsageCount = 0;
          userTier = 'free';
        }

        updateAuthUI();
      });
    }

    // Auth event listeners
    googleSignInBtn.addEventListener('click', signInWithGoogle);
    logoutBtn.addEventListener('click', signOut);

    // Upgrade to Base - Stripe Checkout
    upgradeBtn.addEventListener('click', async () => {
      if (!currentUser) {
        showError('Please sign in first to upgrade');
        return;
      }

      upgradeBtn.disabled = true;
      upgradeBtn.textContent = 'Loading...';

      try {
        // SECURITY: User info is now derived from authenticated session on server
        // No need to send userId or email in the request body
        const res = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          credentials: 'include'
        });

        const data = await res.json();

        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        } else {
          throw new Error(data.error || 'Failed to create checkout session');
        }
      } catch (err) {
        console.error('Checkout error:', err);
        showError('Failed to start checkout: ' + err.message);
        upgradeBtn.disabled = false;
        upgradeBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          UPGRADE
        `;
      }
    });

    // =====================================================
    // ADMIN FUNCTIONS
    // =====================================================

    // Check if admin session is valid
    // SECURITY: Cookie is sent automatically with credentials: 'include'
    async function checkAdminStatus() {
      try {
        const res = await fetch('/api/admin/status', {
          credentials: 'include' // Required for httpOnly cookies
        });
        // Handle non-JSON responses gracefully (e.g., 404 HTML pages)
        if (!res.ok) {
          return false;
        }
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          return false;
        }
        const data = await res.json();
        isAdminLoggedIn = data.isAdmin === true;
        return isAdminLoggedIn;
      } catch (err) {
        // Silently fail - admin status is not critical for anonymous users
        return false;
      }
    }

    // Login as admin
    // SECURITY: Token is stored in httpOnly cookie by server, not in JavaScript
    async function adminLogin(password) {
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // Required for httpOnly cookies
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }

        // Token is now in httpOnly cookie, we just track logged-in state
        isAdminLoggedIn = true;
        return true;
      } catch (err) {
        throw err;
      }
    }

    // Logout admin
    // SECURITY: Server clears the httpOnly cookie
    async function adminLogout() {
      try {
        await fetch('/api/admin/logout', {
          method: 'POST',
          credentials: 'include' // Required for httpOnly cookies
        });
      } catch (err) {
        console.error('Admin logout error:', err);
      }

      isAdminLoggedIn = false;
      updateAdminUI(false);
    }

    // Fetch debug info
    // SECURITY: Cookie is sent automatically with credentials: 'include'
    async function fetchDebugInfo() {
      if (!isAdminLoggedIn) return null;

      try {
        const res = await fetch('/api/admin/debug', {
          credentials: 'include' // Required for httpOnly cookies
        });

        if (!res.ok) {
          if (res.status === 401) {
            // Token expired, logout
            adminLogout();
            return null;
          }
          throw new Error('Failed to fetch debug info');
        }

        return await res.json();
      } catch (err) {
        console.error('Debug fetch error:', err);
        return null;
      }
    }

    // Update admin UI
    function updateAdminUI(isAdmin) {
      if (isAdmin) {
        adminBadge.classList.add('visible');
        adminOverlay.classList.remove('visible');
        usageBadge.textContent = 'ADMIN MODE [UNLIMITED]';
        usageBadge.classList.add('debug');
        updateDebugVisibility();
        const storedDebug = localStorage.getItem('epsteinswap_debug') === 'true';
        setDebugMode(storedDebug, 'admin');
        refreshDebugPanel();
      } else {
        adminBadge.classList.remove('visible');
        adminPanel.classList.remove('visible');
        adminPanelVisible = false;
        updateDebugVisibility();
        if (devDebugAllowed) {
          setDebugMode(devDebugEnabled, 'dev');
        } else {
          setDebugMode(false, 'none');
        }
      }
    }

    // Render debug panel stats
    function renderDebugStats(data) {
      if (!data) return;

      // Server stats
      const serverHtml = `
        <div class="admin-stat-row">
          <span class="admin-stat-label">Uptime</span>
          <span class="admin-stat-value">${formatUptime(data.server?.uptime)}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Node Version</span>
          <span class="admin-stat-value">${data.server?.nodeVersion || 'N/A'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Memory (RSS)</span>
          <span class="admin-stat-value">${formatBytes(data.server?.memoryUsage?.rss)}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Platform</span>
          <span class="admin-stat-value">${data.server?.platform || 'N/A'}</span>
        </div>
      `;
      document.getElementById('adminServerStats').innerHTML = serverHtml;

      // Config stats
      const configHtml = `
        <div class="admin-stat-row">
          <span class="admin-stat-label">Gemini API</span>
          <span class="admin-stat-value ${data.config?.apiKeySet ? 'good' : 'bad'}">${data.config?.apiKeySet ? 'Set' : 'Missing'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Stripe</span>
          <span class="admin-stat-value ${data.config?.stripeConfigured ? 'good' : 'warn'}">${data.config?.stripeConfigured ? 'Configured' : 'Not Set'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Supabase</span>
          <span class="admin-stat-value ${data.config?.supabaseConfigured ? 'good' : 'warn'}">${data.config?.supabaseConfigured ? 'Configured' : 'Not Set'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Model</span>
          <span class="admin-stat-value">${data.config?.model || 'N/A'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Timeout</span>
          <span class="admin-stat-value">${(data.config?.timeout / 1000) || 120}s</span>
        </div>
      `;
      document.getElementById('adminConfigStats').innerHTML = configHtml;

      // Usage stats
      const usageHtml = `
        <div class="admin-stat-row">
          <span class="admin-stat-label">Epstein Photos</span>
          <span class="admin-stat-value">${data.stats?.epsteinPhotosCount || 0}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Anonymous Users</span>
          <span class="admin-stat-value">${data.stats?.anonymousUsersTracked || 0}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Active Admin Sessions</span>
          <span class="admin-stat-value">${data.stats?.activeAdminSessions || 0}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Your Tier</span>
          <span class="admin-stat-value good">${data.currentRequest?.userTier || 'admin'}</span>
        </div>
      `;
      document.getElementById('adminUsageStats').innerHTML = usageHtml;

      // Supabase stats
      const supabaseHtml = `
        <div class="admin-stat-row">
          <span class="admin-stat-label">Connected</span>
          <span class="admin-stat-value ${data.supabase?.connected ? 'good' : 'bad'}">${data.supabase?.connected ? 'Yes' : 'No'}</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">URL</span>
          <span class="admin-stat-value">${data.supabase?.url || 'N/A'}</span>
        </div>
      `;
      document.getElementById('adminSupabaseStats').innerHTML = supabaseHtml;

      // Last generation debug
      if (lastGenerationDebugInfo) {
        const genSection = document.getElementById('lastGenerationDebug');
        genSection.style.display = 'block';
        document.getElementById('adminGenerationStats').innerHTML = `
          <div class="admin-stat-row">
            <span class="admin-stat-label">Generation Time</span>
            <span class="admin-stat-value good">${lastGenerationDebugInfo.generationTime}ms</span>
          </div>
          <div class="admin-stat-row">
            <span class="admin-stat-label">Model</span>
            <span class="admin-stat-value">${lastGenerationDebugInfo.model}</span>
          </div>
          <div class="admin-stat-row">
            <span class="admin-stat-label">Output Size</span>
            <span class="admin-stat-value">${lastGenerationDebugInfo.outputDimensions?.width}x${lastGenerationDebugInfo.outputDimensions?.height}</span>
          </div>
          <div class="admin-stat-row">
            <span class="admin-stat-label">Input Size</span>
            <span class="admin-stat-value">${lastGenerationDebugInfo.inputDimensions?.width}x${lastGenerationDebugInfo.inputDimensions?.height}</span>
          </div>
          <div class="admin-stat-row">
            <span class="admin-stat-label">Watermark</span>
            <span class="admin-stat-value ${lastGenerationDebugInfo.watermarkApplied ? 'warn' : 'good'}">${lastGenerationDebugInfo.watermarkApplied ? 'Yes' : 'No'}</span>
          </div>
        `;
      }
    }

    // Refresh debug panel
    async function refreshDebugPanel() {
      const data = await fetchDebugInfo();
      if (data) {
        renderDebugStats(data);
      }
    }

    // Format helpers
    function formatUptime(seconds) {
      if (!seconds) return 'N/A';
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      if (hrs > 0) return `${hrs}h ${mins}m`;
      if (mins > 0) return `${mins}m ${secs}s`;
      return `${secs}s`;
    }

    function formatBytes(bytes) {
      if (!bytes) return 'N/A';
      const mb = bytes / (1024 * 1024);
      return mb.toFixed(1) + ' MB';
    }

    // Show admin login modal
    function showAdminLogin() {
      adminOverlay.classList.add('visible');
      adminPasswordInput.value = '';
      adminLoginError.classList.remove('visible');
      setTimeout(() => adminPasswordInput.focus(), 100);
    }

    // Hide admin login modal
    function hideAdminLogin() {
      adminOverlay.classList.remove('visible');
    }

    // Toggle admin panel visibility
    function toggleAdminPanel() {
      adminPanelVisible = !adminPanelVisible;
      if (adminPanelVisible) {
        adminPanel.classList.add('visible');
        refreshDebugPanel();
      } else {
        adminPanel.classList.remove('visible');
      }
    }

    // Initialize admin
    // SECURITY: Check if admin cookie is still valid on page load
    async function initAdmin() {
      // Check if there's a valid admin session via httpOnly cookie
      const isValid = await checkAdminStatus();
      if (isValid) {
        updateAdminUI(true);
      }
    }

    // Admin event listeners
    adminBadge.addEventListener('click', toggleAdminPanel);

    adminCloseBtn.addEventListener('click', hideAdminLogin);

    adminOverlay.addEventListener('click', (e) => {
      if (e.target === adminOverlay) hideAdminLogin();
    });

    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = adminPasswordInput.value.trim();

      if (!password) {
        adminLoginError.textContent = 'Password is required';
        adminLoginError.classList.add('visible');
        return;
      }

      adminLoginBtn.disabled = true;
      adminLoginBtn.textContent = 'Logging in...';
      adminLoginError.classList.remove('visible');

      try {
        await adminLogin(password);
        updateAdminUI(true);
        showToast('ADMIN ACCESS GRANTED');
      } catch (err) {
        adminLoginError.textContent = err.message;
        adminLoginError.classList.add('visible');
      } finally {
        adminLoginBtn.disabled = false;
        adminLoginBtn.textContent = 'Login';
      }
    });

    adminLogoutBtn.addEventListener('click', () => {
      adminLogout();
      showToast('ADMIN ACCESS REVOKED');
    });

    refreshDebugBtn.addEventListener('click', refreshDebugPanel);

    // Keyboard shortcut: Ctrl+Shift+A for admin login
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        if (isAdminLoggedIn) {
          toggleAdminPanel();
        } else {
          showAdminLogin();
        }
      }
      // Escape to close panels
      if (e.key === 'Escape') {
        if (adminOverlay.classList.contains('visible')) {
          hideAdminLogin();
        }
        if (adminPanel.classList.contains('visible')) {
          adminPanel.classList.remove('visible');
          adminPanelVisible = false;
        }
      }
    });

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      updateDebugToggle();

      // Load config from server first (required for Supabase auth)
      await loadConfig();

      await fetchDevDebugStatus();

      await Promise.all([
        initAuth(),
        initAdmin(),
        loadGallery()
      ]);

      updateDebugVisibility();
      if (!isAdminLoggedIn) {
        if (devDebugAllowed) {
          setDebugMode(devDebugEnabled, 'dev');
        } else {
          setDebugMode(false, 'none');
        }
      }

      // Handle watermark removal success redirect
      await handleWatermarkRemovalRedirect();
    }

    /**
     * Handle redirect back from Stripe after watermark removal purchase
     * Detects ?watermark_removed=true&session_id=... URL parameters
     */
    async function handleWatermarkRemovalRedirect() {
      const urlParams = new URLSearchParams(window.location.search);
      const watermarkRemoved = urlParams.get('watermark_removed');
      const sessionId = urlParams.get('session_id');
      const canceled = urlParams.get('canceled');

      // Handle canceled checkout
      if (canceled === 'true') {
        showToast('CHECKOUT CANCELED');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      }

      // Handle successful watermark removal purchase
      if (watermarkRemoved === 'true' && sessionId) {
        try {
          // Show immediate success feedback
          showToast('GENERATING PREMIUM IMAGE...');

          // Verify the session with the server first (adds credits)
          const token = getAuthToken();
          if (token) {
            const response = await fetch('/api/verify-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ sessionId })
            });

            if (response.ok) {
              const verifyResult = await response.json();
              console.log('Watermark removal session verified:', verifyResult);

              // Refresh user usage stats to reflect new credits
              await fetchUserUsage();
              updateAuthUI();
            } else {
              console.warn('Could not verify watermark removal session:', await response.text());
            }
          }

          // Retrieve stored photos for regeneration
          const pendingUserPhoto = sessionStorage.getItem('pendingUserPhoto');
          const pendingEpsteinPhoto = sessionStorage.getItem('pendingEpsteinPhoto');
          console.log('Post-payment check:', {
            hasPendingUserPhoto: !!pendingUserPhoto,
            hasPendingEpsteinPhoto: !!pendingEpsteinPhoto,
            pendingEpsteinPhoto
          });

          if (pendingUserPhoto && pendingEpsteinPhoto) {
            // Restore the UI state
            previewImg.src = pendingUserPhoto;
            previewContainer.classList.add('visible');
            selectedPhoto = pendingEpsteinPhoto;

            // Select the epstein photo in the gallery
            gallery.querySelectorAll('.gallery-item').forEach(item => {
              item.classList.remove('selected');
              if (item.dataset.path === pendingEpsteinPhoto) {
                item.classList.add('selected');
              }
            });

            // Clean up sessionStorage
            sessionStorage.removeItem('pendingUserPhoto');
            sessionStorage.removeItem('pendingEpsteinPhoto');

            // Auto-trigger premium generation (user now has credits)
            loading.classList.add('visible');
            result.classList.remove('visible');

            // Convert data URL to blob for form submission
            const blob = await (await fetch(pendingUserPhoto)).blob();
            const formData = new FormData();
            formData.append('userPhoto', blob, 'face.jpg');
            formData.append('epsteinPhoto', pendingEpsteinPhoto);
            formData.append('modelType', 'premium'); // Use premium model

            const genResponse = await fetch('/api/generate', {
              method: 'POST',
              headers: token ? { 'Authorization': `Bearer ${token}` } : {},
              body: formData,
              credentials: 'include'
            });

            const genData = await genResponse.json();
            if (genData.imageUrl) {
              resultImage.src = genData.imageUrl;
              result.classList.add('visible');
              loading.classList.remove('visible');

              // Hide watermark promo since they just paid
              if (watermarkPromo) {
                watermarkPromo.classList.add('hidden');
              }

              showToast('PREMIUM IMAGE READY!');
            } else {
              throw new Error(genData.error || 'Generation failed');
            }
          } else {
            // No stored photos - just show success message
            showToast('WATERMARK REMOVAL UNLOCKED!');
          }
        } catch (err) {
          console.warn('Error in post-payment flow:', err);
          loading.classList.remove('visible');
          showError('Generation failed - try again with your new credits');
        }

        // Clean up URL to remove query params
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    async function loadGallery() {
      try {
        const res = await fetch('/api/photos');
        const data = await res.json();
        epsteinPhotos = data.photos;
        renderGallery();

        // Auto-select random photo
        if (epsteinPhotos.length > 0) {
          selectRandomPhoto();
        }
      } catch (err) {
        showError('Failed to load gallery');
      }
    }

    function renderGallery() {
      gallery.innerHTML = epsteinPhotos.map((photo, i) => `
        <div class="gallery-item" data-index="${i}" data-path="${photo.path}">
          <img src="${photo.path}" alt="${photo.name}" loading="lazy">
          <div class="check"></div>
        </div>
      `).join('');

      // Add click handlers
      gallery.querySelectorAll('.gallery-item').forEach(item => {
        item.addEventListener('click', () => selectPhoto(item));
      });
    }

    function selectPhoto(item) {
      // Remove previous selection
      gallery.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('selected'));

      // Select new
      item.classList.add('selected');
      selectedPhoto = item.dataset.path;
      checkReady();
    }

    function selectRandomPhoto() {
      const items = gallery.querySelectorAll('.gallery-item');
      if (items.length === 0) return;

      const randomIndex = Math.floor(Math.random() * items.length);
      selectPhoto(items[randomIndex]);
    }

    // Random button
    randomBtn.addEventListener('click', selectRandomPhoto);

    // Upload handling
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    });

    // =====================================================
    // CAMERA CAPTURE FUNCTIONALITY
    // =====================================================

    const cameraBtn = document.getElementById('cameraBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const cameraVideo = document.getElementById('cameraVideo');
    const captureCanvas = document.getElementById('captureCanvas');
    const captureBtn = document.getElementById('captureBtn');
    const cameraCancelBtn = document.getElementById('cameraCancelBtn');

    let cameraStream = null;

    // Open camera
    cameraBtn.addEventListener('click', async () => {
      try {
        // Request camera access with optimal constraints for face capture
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });

        cameraVideo.srcObject = cameraStream;
        cameraOverlay.classList.add('visible');
      } catch (err) {
        if (err.name === 'NotAllowedError') {
          showError('Camera permission denied. Please enable camera access in your browser settings.');
        } else if (err.name === 'NotFoundError') {
          showError('No camera found on this device.');
        } else {
          showError('Unable to access camera: ' + err.message);
        }
      }
    });

    // Capture photo from video
    captureBtn.addEventListener('click', () => {
      if (!cameraStream) return;

      // Get video dimensions
      const videoWidth = cameraVideo.videoWidth;
      const videoHeight = cameraVideo.videoHeight;

      // Set canvas dimensions to match video
      captureCanvas.width = videoWidth;
      captureCanvas.height = videoHeight;

      // Draw video frame to canvas
      const ctx = captureCanvas.getContext('2d');
      ctx.drawImage(cameraVideo, 0, 0, videoWidth, videoHeight);

      // Convert canvas to blob and create File
      captureCanvas.toBlob((blob) => {
        const file = new File([blob], 'camera-capture.jpg', {
          type: 'image/jpeg',
          lastModified: Date.now()
        });

        // Handle the captured file
        handleFile(file);

        // Close camera modal
        closeCameraModal();
      }, 'image/jpeg', 0.95);
    });

    // Close camera modal
    function closeCameraModal() {
      cameraOverlay.classList.remove('visible');
      stopCamera();
    }

    cameraCancelBtn.addEventListener('click', closeCameraModal);

    // Close modal when clicking outside the modal box
    cameraOverlay.addEventListener('click', (e) => {
      if (e.target === cameraOverlay) {
        closeCameraModal();
      }
    });

    // Stop camera stream
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        cameraVideo.srcObject = null;
      }
    }

    // Clean up camera on page unload
    window.addEventListener('beforeunload', stopCamera);

    // Maximum file size: 10MB
    const MAX_FILE_SIZE = 10 * 1024 * 1024;

    function handleFile(file) {
      // Check file type
      if (!file.type.match(/image\/(jpeg|png|webp)/)) {
        showError('Please upload a JPG, PNG, or WebP image');
        return;
      }

      // Check file size (10MB max)
      if (file.size > MAX_FILE_SIZE) {
        showError('File is too large. Maximum size is 10MB. Please compress your image or use a smaller resolution.');
        return;
      }

      userFile = file;
      uploadZone.classList.add('has-file');

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewContainer.classList.add('visible');
      };
      reader.readAsDataURL(file);

      checkReady();
    }

    // Track quick/premium remaining counts
    // Default to FREE tier values (5 quick + 1 premium)
    // Anonymous users (3 quick + 0 premium) will be updated by fetchAnonymousUsage()
    let quickRemainingCount = 5;
    let premiumRemainingCount = 1;

    function checkReady() {
      // Check if both photo and user file are selected
      const canGenerate = selectedPhoto && userFile;

      // Enable/disable buttons based on readiness AND remaining counts
      // Debug mode bypasses quota checks (unlimited generations)
      const bypassQuota = debugMode || isAdminLoggedIn;
      generateQuickBtn.disabled = !canGenerate || (!bypassQuota && quickRemainingCount <= 0);
      generatePremiumBtn.disabled = !canGenerate || (!bypassQuota && premiumRemainingCount <= 0);

      // Update remaining count display
      updateRemainingDisplay();
    }

    function updateRemainingDisplay() {
      // Base tier: shared pool of 50/month, show same count on both buttons
      // Free/Anonymous: separate quick and premium quotas
      if (quickRemaining) {
        quickRemaining.textContent = quickRemainingCount > 0 ? `${quickRemainingCount} left` : 'none left';
      }
      if (premiumRemaining) {
        premiumRemaining.textContent = premiumRemainingCount > 0 ? `${premiumRemainingCount} left` : 'none left';
      }
    }

    // Compress image client-side to avoid Vercel's 4.5MB payload limit
    async function compressImage(file, maxDimension = 2048, quality = 0.85) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let { width, height } = img;

          // Calculate new dimensions maintaining aspect ratio
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = Math.round((height * maxDimension) / width);
              width = maxDimension;
            } else {
              width = Math.round((width * maxDimension) / height);
              height = maxDimension;
            }
          }

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            const compressedFile = new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), {
              type: 'image/jpeg',
              lastModified: Date.now()
            });
            resolve(compressedFile);
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // Loading message cycling
    function startLoadingMessages() {
      let messageIndex = 0;
      updateLoadingMessage(messageIndex);

      loadingInterval = setInterval(() => {
        messageIndex = Math.min(messageIndex + 1, loadingMessages.length - 1);
        updateLoadingMessage(messageIndex);
      }, 6000);
    }

    function updateLoadingMessage(index) {
      const msg = loadingMessages[index];
      loadingTitle.textContent = msg.title;
      loadingSubtitle.textContent = msg.subtitle;
      loadingTips.textContent = msg.tip;
    }

    function stopLoadingMessages() {
      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }
    }

    // Generate function - handles both Quick and Premium
    async function handleGenerate(modelType) {
      if (!selectedPhoto || !userFile) return;

      // Check if user can generate with this model type
      if (!debugMode && !isAdminLoggedIn) {
        if (modelType === 'quick' && quickRemainingCount <= 0) {
          showError('No quick generations left! Try Premium or upgrade to Base.');
          return;
        }
        if (modelType === 'premium' && premiumRemainingCount <= 0) {
          showError('No premium generations left! Upgrade to Base for more.');
          return;
        }
      }

      hideError();
      mainContent.style.display = 'none';
      loading.classList.add('visible');

      // Update loading message based on model type
      const modelName = modelType === 'premium' ? 'PREMIUM' : 'QUICK (EXPERIMENTAL)';
      loadingTitle.textContent = `${modelName} GENERATION...`;
      startLoadingMessages();

      // Funny VHS effect - "camera disconnected" during generation
      const recIndicator = document.getElementById('recIndicator');
      const funnyMessages = [
        'SIGNAL LOST',
        'FEED INTERRUPTED',
        'CAM MALFUNCTION',
        'TAPE CORRUPTED',
        'NO SIGNAL',
        'EVIDENCE DELETED'
      ];
      recIndicator.textContent = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
      recIndicator.classList.add('disconnected');

      // Compress image client-side to avoid Vercel's 4.5MB payload limit
      const compressedFile = await compressImage(userFile, 2048, 0.85);
      console.log(`Compressed: ${(userFile.size / 1024 / 1024).toFixed(2)}MB  ${(compressedFile.size / 1024 / 1024).toFixed(2)}MB`);

      const formData = new FormData();
      formData.append('userPhoto', compressedFile);
      formData.append('epsteinPhoto', selectedPhoto);
      formData.append('modelType', modelType);  // NEW: Send model type
      formData.append('debug', debugMode);

      try {
        // Build request options with auth header if logged in
        const token = getAuthToken();
        const fetchOptions = {
          method: 'POST',
          body: formData,
          headers: {},
          credentials: 'include' // SECURITY: Required for httpOnly admin cookies
        };

        // Add Authorization header if we have a token
        if (token) {
          fetchOptions.headers['Authorization'] = `Bearer ${token}`;
        }

        // Admin token is now sent automatically via httpOnly cookie
        // No need to manually add X-Admin-Token header

        const res = await fetch('/api/generate', fetchOptions);

        // Handle non-JSON error responses (e.g., from Express error middleware)
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          // Server returned non-JSON (plain text error)
          const text = await res.text();
          throw new Error(text || 'Server error - please try again');
        }

        if (!res.ok || data.error) {
          throw new Error(data.error || data.message || 'Generation failed');
        }

        // Capture debug info for admin panel
        if (data.debug) {
          lastGenerationDebugInfo = data.debug;
          if (adminPanelVisible) {
            refreshDebugPanel();
          }
        }

        // Update usage from server response (unless debug)
        if (!debugMode && data.usage) {
          if (data.usage.quickRemaining !== undefined) {
            quickRemainingCount = Math.max(0, data.usage.quickRemaining);
          }
          if (data.usage.premiumRemaining !== undefined) {
            premiumRemainingCount = Math.max(0, data.usage.premiumRemaining);
          }
          updateRemainingDisplay();

          if (currentUser) {
            serverUsageCount = data.usage.used || serverUsageCount + 1;
            updateAuthUI();
          } else {
            usageCount++;
            localStorage.setItem('epsteinswap_usage', usageCount.toString());
            updateUsageBadge();
          }
        }

        stopLoadingMessages();
        recIndicator.textContent = 'REC ';
        recIndicator.classList.remove('disconnected');

        // Store generation identifiers for watermark removal flow
        lastGenerationId = data.generationId || null;
        lastViewToken = data.viewToken || null;
        // Persist to sessionStorage for Stripe redirect round-trip
        if (lastGenerationId) {
          sessionStorage.setItem('lastGenerationId', lastGenerationId);
        }
        if (lastViewToken) {
          sessionStorage.setItem('lastViewToken', lastViewToken);
        }

        // Set image source
        // Note: data URLs (base64) don't support query params, only append viewToken to http URLs
        let imageUrl = data.imageUrl;
        if (data.viewToken && imageUrl && !imageUrl.startsWith('data:')) {
          imageUrl += `?viewToken=${data.viewToken}`;
        }
        resultImage.src = imageUrl;
        loading.classList.remove('visible');
        result.classList.add('visible');
        result.classList.add('animate-in');

        // Show/hide watermark removal promo based on user tier
        updateWatermarkPromo();

      } catch (err) {
        stopLoadingMessages();
        recIndicator.textContent = 'REC ';
        recIndicator.classList.remove('disconnected');
        loading.classList.remove('visible');
        mainContent.style.display = 'block';
        showError(err.message);
      }
    }

    // Quick Generate button
    generateQuickBtn.addEventListener('click', () => handleGenerate('quick'));

    // Premium Generate button
    generatePremiumBtn.addEventListener('click', () => handleGenerate('premium'));

    // Download
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = resultImage.src;
      link.download = 'pimpmyepstein-' + Date.now() + '.png';
      link.click();
    });

    // Share
    shareBtn.addEventListener('click', async () => {
      const imageUrl = resultImage.src;

      // Try native share API first (mobile)
      if (navigator.share && navigator.canShare) {
        try {
          // Try to share the image directly if supported
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const file = new File([blob], 'pimpmyepstein.png', { type: 'image/png' });

          if (navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: 'PIMP MY EPSTEIN',
              text: 'I INJECTED MY FACE INTO HISTORY',
              files: [file]
            });
            return;
          }
        } catch (e) {
          // Fall through to URL sharing
        }

        // Fall back to sharing URL
        try {
          await navigator.share({
            title: 'PIMP MY EPSTEIN',
            text: 'I INJECTED MY FACE INTO HISTORY',
            url: window.location.href
          });
          return;
        } catch (e) {
          // User cancelled or error, fall through to clipboard
        }
      }

      // Fallback: copy image URL to clipboard
      try {
        await navigator.clipboard.writeText(imageUrl);
        showToast('LINK COPIED');
      } catch (e) {
        // Final fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = imageUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('LINK COPIED');
      }
    });

    // Toast notification
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 3000);
    }

    // Try another
    anotherBtn.addEventListener('click', () => {
      result.classList.remove('visible');
      mainContent.style.display = 'block';

      // Reset
      userFile = null;
      fileInput.value = '';
      previewContainer.classList.remove('visible');
      uploadZone.classList.remove('has-file');

      // Pick new random photo
      selectRandomPhoto();
      checkReady();
    });

    // Remove Watermark button - redirect to Stripe checkout
    // REQUIRES sign-in first (classic SaaS funnel)
    removeWatermarkBtn.addEventListener('click', async () => {
      try {
        removeWatermarkBtn.disabled = true;
        removeWatermarkBtn.textContent = 'LOADING...';

        // Require sign-in for watermark removal (classic SaaS conversion funnel)
        if (!currentUser) {
          // Store everything needed for post-payment regeneration
          if (previewImg.src && previewImg.src.startsWith('data:')) {
            sessionStorage.setItem('pendingUserPhoto', previewImg.src);
          }
          if (selectedPhoto) {
            sessionStorage.setItem('pendingEpsteinPhoto', selectedPhoto);
          }
          sessionStorage.setItem('pendingWatermarkRemoval', 'true');

          showToast('SIGN IN TO REMOVE WATERMARK');
          removeWatermarkBtn.disabled = false;
          removeWatermarkBtn.textContent = 'UNLOCK NOW';

          // Trigger sign-in flow
          signInWithGoogle();
          return;
        }

        // Get generation info from state or sessionStorage
        const genId = lastGenerationId || sessionStorage.getItem('lastGenerationId');
        const viewTok = lastViewToken || sessionStorage.getItem('lastViewToken');

        // Build headers with auth
        const headers = { 'Content-Type': 'application/json' };
        const token = getAuthToken();
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        // Build request body
        const body = {};
        if (genId) body.generationId = genId;
        if (viewTok) body.viewToken = viewTok;

        const res = await fetch('/api/buy-watermark-removal', {
          method: 'POST',
          headers,
          body: JSON.stringify(body),
          credentials: 'include'
        });

        const data = await res.json();
        if (data.checkoutUrl) {
          // Store data for post-payment regeneration
          // Get the face photo from preview or result image
          const facePhotoSrc = previewImg.src || resultImage.src;
          console.log('Storing for regeneration:', {
            previewSrc: previewImg.src?.substring(0, 50),
            resultSrc: resultImage.src?.substring(0, 50),
            selectedPhoto
          });
          if (facePhotoSrc && facePhotoSrc.startsWith('data:')) {
            sessionStorage.setItem('pendingUserPhoto', facePhotoSrc);
            console.log('Stored pendingUserPhoto');
          }
          if (selectedPhoto) {
            sessionStorage.setItem('pendingEpsteinPhoto', selectedPhoto);
            console.log('Stored pendingEpsteinPhoto:', selectedPhoto);
          }
          window.location.href = data.checkoutUrl;
        } else {
          throw new Error(data.error || 'Failed to create checkout');
        }
      } catch (err) {
        showError(err.message);
        removeWatermarkBtn.disabled = false;
        removeWatermarkBtn.textContent = 'UNLOCK NOW';
      }
    });

    // Show/hide watermark promo based on user tier (hide for paid users)
    function updateWatermarkPromo() {
      if (!watermarkPromo) return;
      // Hide for base/paid users (they already have watermark-free)
      // Show for free/anonymous users
      const isPaidUser = userTier === 'base' || userTier === 'pro';
      watermarkPromo.classList.toggle('hidden', isPaidUser || debugMode || isAdminLoggedIn);
    }

    // Usage badge
    function updateUsageBadge() {
      const remaining = ANON_MAX_USAGE - usageCount;
      if (debugMode) {
        usageBadge.textContent = 'DEBUG MODE [UNLIMITED]';
        usageBadge.classList.add('debug');
      } else if (remaining <= 0) {
        usageBadge.textContent = 'NO SWAPS REMAINING';
      } else {
        usageBadge.textContent = `${remaining} SWAP${remaining !== 1 ? 'S' : ''} REMAINING`;
        usageBadge.classList.remove('debug');
      }
      checkReady();
    }

    // Debug toggle (triple-click to toggle)
    let debugClicks = 0;
    debugToggle.addEventListener('click', () => {
      debugClicks++;
      if (debugClicks >= 3) {
        if (isAdminLoggedIn) {
          const next = !debugMode;
          localStorage.setItem('epsteinswap_debug', next.toString());
          setDebugMode(next, 'admin');
        } else if (devDebugAllowed) {
          const next = !debugMode;
          setDevDebug(next).then((result) => {
            if (!result.allowed) {
              showError('Dev debug not available');
              return;
            }
            devDebugEnabled = result.enabled === true;
            setDebugMode(devDebugEnabled, 'dev');
          }).catch(() => {
            showError('Failed to toggle dev debug');
          });
        }
        debugClicks = 0;
      }
      setTimeout(() => { debugClicks = 0; }, 1000);
    });

    function updateDebugToggle() {
      if (debugMode) {
        const suffix = debugModeSource === 'dev' ? ' (LOCAL)' : '';
        debugToggle.textContent = `Debug: ON${suffix}`;
      } else {
        debugToggle.textContent = 'Debug: OFF';
      }
    }

    // Error handling
    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.add('visible');
    }

    function hideError() {
      errorDiv.classList.remove('visible');
    }

    // Start
    init();
  </script>
</body>

</html>
