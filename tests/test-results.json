{
  "total": 20,
  "passed": 15,
  "failed": 5,
  "skipped": 0,
  "errored": 0,
  "duration": 8988,
  "timestamp": "2025-12-29T04:41:03.090Z",
  "results": [
    {
      "name": "unit",
      "description": "Unit Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 64,
      "output": "==================================================\nPimp My Epstein Unit Tests\n==================================================\n\n\n=== Generations Service Tests ===\n\ncreateGeneration:\n  ‚úì creates generation with unique id\n  ‚úì creates generation with correct userId\n  ‚úì creates generation with correct epsteinPhoto\n  ‚úì creates generation with pending status\n  ‚úì creates generation with null resultUrl\n  ‚úì creates generation with null error fields\n  ‚úì creates generation with createdAt timestamp\n  ‚úì creates generation with null completedAt\n  ‚úì generates unique IDs for each generation\n\ncompleteGeneration:\n  ‚úì updates status to completed\n  ‚úì sets resultUrl correctly\n  ‚úì sets completedAt timestamp\n  ‚úì returns null for non-existent id\n\nfailGeneration:\n  ‚úì updates status to failed\n  ‚úì sets errorCode correctly\n  ‚úì sets errorMessage correctly\n  ‚úì sets completedAt timestamp on failure\n  ‚úì returns null for non-existent id\n\ngetGeneration:\n  ‚úì retrieves generation by id\n  ‚úì returns null for non-existent id\n\ngetGenerations:\n  ‚úì returns empty array for user with no generations\n  ‚úì returns generations for user\n  ‚úì only returns generations for specified user\n  ‚úì respects limit parameter\n  ‚úì returns results sorted by createdAt descending\n\nSTATUS constants:\n  ‚úì has PENDING status\n  ‚úì has COMPLETED status\n  ‚úì has FAILED status\n\nclearAll:\n  ‚úì clears all generations\n\n=== Usage Service Tests ===\n\ngetUserTier:\n  ‚úì returns anonymous for null userId\n  ‚úì returns anonymous for undefined userId\n  ‚úì returns free for user with no subscription\n  ‚úì returns free for user with inactive subscription\n  ‚úì returns paid for user with active subscription\n  ‚úì returns free for user without profile\n\ncheckUsage:\n  ‚úì anonymous user has limit of 1\n  ‚úì anonymous user starts with 0 used\n  ‚úì anonymous user canGenerate is true initially\n  ‚úì free user has limit of 3\n  ‚úì paid user has unlimited limit\n  ‚úì returns correct tier name\n  ‚úì calculates remaining correctly\n  ‚úì remaining is 0 when at limit\n  ‚úì canGenerate is false when at limit\n  ‚úì canGenerate is false when over limit\n  ‚úì paid user canGenerate is always true\n  ‚úì paid user remaining is unlimited\n\nincrementUsage:\n  ‚úì increments anonymous usage in memory\n  ‚úì anonymous shouldUpdateDb is false\n  ‚úì authenticated user shouldUpdateDb is true\n  ‚úì authenticated user gets correct newCount\n  ‚úì authenticated user at limit cannot increment\n  ‚úì handles null profile for authenticated user\n\nresetAnonymousUsage:\n  ‚úì resets usage for IP\n\ngetAnonymousStats:\n  ‚úì returns totalTracked number\n  ‚úì totalTracked increases with new IPs\n\n=== Tiers Configuration Tests ===\n\nTier definitions:\n  ‚úì anonymous tier exists\n  ‚úì anonymous tier has limit of 1\n  ‚úì anonymous tier has name\n  ‚úì free tier exists\n  ‚úì free tier has limit of 3\n  ‚úì free tier has name\n  ‚úì paid tier exists\n  ‚úì paid tier has unlimited limit\n  ‚úì paid tier has name\n  ‚úì all tiers have descriptions\n\n=== Error Code Handling Tests ===\n\nError codes in generations:\n  ‚úì generation can fail with NO_FACE code\n  ‚úì generation can fail with MULTIPLE_FACES code\n  ‚úì generation can fail with IMAGE_TOO_SMALL code\n  ‚úì generation can fail with SAFETY_BLOCK code\n  ‚úì generation can fail with RATE_LIMITED code\n  ‚úì generation can fail with TIMEOUT code\n  ‚úì generation can fail with INVALID_FORMAT code\n  ‚úì generation can fail with GENERATION_FAILED code\n  ‚úì failed generation preserves error message\n\n==================================================\nTest Summary\n==================================================\nPassed: 75\nFailed: 0\nTotal:  75\n\nAll tests passed!\n",
      "passed": 75,
      "failed": 0
    },
    {
      "name": "services-usage",
      "description": "Usage Service Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 52,
      "output": "============================================================\nUsage Service Unit Tests\n============================================================\n\n=== Anonymous Usage Tracking by IP ===\n\n  [PASS] new IP address starts with 0 used\n  [PASS] anonymous users are identified by IP address\n  [PASS] multiple increments for same IP - atomic limit enforcement\n  [PASS] anonymous user tier is correctly identified\n  [PASS] anonymous usage limit is 1\n  [PASS] anonymous user can generate when under limit\n  [PASS] anonymous user cannot generate when at limit\n  [PASS] anonymous user cannot generate when over limit\n  [PASS] resetAnonymousUsage clears usage for IP\n  [PASS] incrementUsage returns correct newCount for anonymous\n  [PASS] incrementUsage returns shouldUpdateDb false for anonymous\n\n=== Authenticated User Usage Tracking ===\n\n  [PASS] authenticated user with null profile returns free tier\n  [PASS] authenticated user with empty profile returns free tier\n  [PASS] free user has correct tier info\n  [PASS] free user limit is 3\n  [PASS] free user used count comes from profile.generation_count\n  [PASS] free user remaining is calculated correctly\n  [PASS] free user can generate when under limit\n  [PASS] free user cannot generate when at limit\n  [PASS] free user cannot generate when over limit\n  [PASS] incrementUsage returns correct newCount for authenticated user\n  [PASS] incrementUsage returns shouldUpdateDb true for authenticated user\n  [PASS] incrementUsage fails for authenticated user at limit\n  [PASS] incrementUsage handles null profile generation_count\n  [PASS] incrementUsage handles missing generation_count property\n  [PASS] incrementUsage handles undefined generation_count\n\n=== Usage Limits Enforcement ===\n\n  [PASS] anonymous limit matches tiers config\n  [PASS] free limit matches tiers config\n  [PASS] paid limit is Infinity in tiers config\n  [PASS] paid limit displayed as unlimited string\n  [PASS] canGenerate boundary: anonymous at exactly 0\n  [PASS] canGenerate boundary: anonymous at exactly 1\n  [PASS] canGenerate boundary: free at exactly 2\n  [PASS] canGenerate boundary: free at exactly 3\n  [PASS] remaining never goes negative\n\n=== incrementUsage Tests ===\n\n  [PASS] anonymous increment stores in memory\n  [PASS] authenticated increment does not modify profile object\n  [PASS] increment enforces limit for anonymous\n  [PASS] paid user increment still requires DB update\n\n=== checkUsage Return Value Tests ===\n\n  [PASS] checkUsage returns used property\n  [PASS] checkUsage returns limit property\n  [PASS] checkUsage returns remaining property\n  [PASS] checkUsage returns canGenerate property\n  [PASS] checkUsage returns tier property\n  [PASS] checkUsage returns tierName property\n  [PASS] checkUsage for paid user returns unlimited remaining\n\n=== getAnonymousStats Tests ===\n\n  [PASS] getAnonymousStats returns object\n  [PASS] getAnonymousStats returns totalTracked property\n  [PASS] getAnonymousStats totalTracked is a number\n  [PASS] totalTracked is non-negative\n  [PASS] totalTracked increases when new IP tracked\n  [PASS] totalTracked does not increase for existing IP\n  [PASS] totalTracked decreases after resetAnonymousUsage\n\n=== Subscription Status Edge Cases ===\n\n  [PASS] subscription_status \"active\" returns paid tier\n  [PASS] subscription_status \"cancelled\" returns free tier\n  [PASS] subscription_status \"inactive\" returns free tier\n  [PASS] subscription_status \"past_due\" returns free tier\n  [PASS] subscription_status \"trialing\" returns free tier\n  [PASS] subscription_status null returns free tier\n  [PASS] subscription_status undefined returns free tier\n  [PASS] subscription_status empty string returns free tier\n  [PASS] subscription_status \"ACTIVE\" (uppercase) returns free tier\n  [PASS] subscription_status \" active \" (whitespace) returns free tier\n\n=== Paid User Unlimited Access ===\n\n  [PASS] paid user canGenerate with 0 count\n  [PASS] paid user canGenerate with high count\n  [PASS] paid user canGenerate with very high count\n  [PASS] paid user tier is correctly identified\n  [PASS] paid user tierName is Pro\n  [PASS] paid user used count still tracks correctly\n\n============================================================\nTest Summary\n============================================================\nPassed: 69\nFailed: 0\nTotal:  69\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "services-generations",
      "description": "Generations Service Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 46,
      "output": "============================================================\nGenerations Service Unit Tests\n============================================================\n\n\n=== createGeneration viewToken Tests ===\n\nAnonymous user viewToken handling:\n  ‚úì anonymous user (null userId) gets a viewToken\n  ‚úì anonymous viewToken is 64 characters (32 bytes hex)\n  ‚úì anonymous viewToken is valid hex\n  ‚úì each anonymous generation gets unique viewToken\n\nAuthenticated user viewToken handling:\n  ‚úì authenticated user (with userId) gets null viewToken\n  ‚úì userId is set for authenticated users\n\nGeneration record structure:\n  ‚úì anonymous generation has all required fields\n\n=== completeGeneration Tests ===\n\nStatus updates:\n  ‚úì updates status from pending to completed\n  ‚úì sets resultUrl correctly\n  ‚úì handles various resultUrl formats\n\nTimestamp handling:\n  ‚úì sets completedAt timestamp\n  ‚úì createdAt is preserved after completion\n\nError handling:\n  ‚úì returns null for non-existent generation id\n  ‚úì returned generation is retrievable\n\n=== failGeneration Tests ===\n\nError code recording:\n  ‚úì records errorCode correctly\n  ‚úì records common error codes\n\nError message recording:\n  ‚úì records errorMessage correctly\n  ‚úì preserves detailed error messages\n  ‚úì handles empty error message\n\nStatus and timestamp handling:\n  ‚úì updates status to failed\n  ‚úì sets completedAt on failure\n  ‚úì resultUrl remains null on failure\n\nError handling:\n  ‚úì returns null for non-existent generation id\n\n=== validateGenerationAccess Tests ===\n\nOwnership validation for authenticated users:\n  ‚úì owner can access their own generation\n  ‚úì non-owner cannot access authenticated generation\n  ‚úì anonymous user cannot access authenticated generation\n\nviewToken validation for anonymous generations:\n  ‚úì correct viewToken grants access to anonymous generation\n  ‚úì incorrect viewToken denies access\n  ‚úì missing viewToken denies access to anonymous generation\n  ‚úì empty string viewToken denies access\n  ‚úì authenticated user cannot use viewToken to access anonymous generation\n\nNon-existent generation handling:\n  ‚úì non-existent generation returns not found\n\nEdge cases:\n  ‚úì viewToken from different generation does not grant access\n  ‚úì case-sensitive viewToken validation\n\n=== Timing-Safe Comparison Tests ===\n\nTiming-safe viewToken validation:\n  ‚úì uses crypto.timingSafeEqual for viewToken comparison\n  ‚úì handles tokens of different lengths safely\n  ‚úì handles very long tokens safely\n  ‚úì timing-safe comparison prevents timing attacks\n\n=== findByResultUrl Tests ===\n\nBasic lookups:\n  ‚úì finds generation by exact resultUrl\n  ‚úì returns null for non-existent resultUrl\n  ‚úì pending generations have null resultUrl\n\nURL format handling:\n  ‚úì handles various URL formats\n  ‚úì URL matching is exact (no partial matches)\n\nMultiple generations:\n  ‚úì returns correct generation when multiple exist\n  ‚úì returns first match if duplicates exist (edge case)\n\nFailed generations:\n  ‚úì failed generations have null resultUrl and are findable by null\n\n=== Integration Tests ===\n\nFull workflow tests:\n  ‚úì complete anonymous generation workflow\n  ‚úì complete authenticated generation workflow\n  ‚úì failed generation workflow\n  ‚úì generation history isolation\n\n============================================================\nTest Summary\n============================================================\nPassed: 50\nFailed: 0\nTotal:  50\n\nAll tests passed!\n",
      "passed": 50,
      "failed": 0
    },
    {
      "name": "services-stripe",
      "description": "Stripe Service Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 39,
      "output": "============================================================\nStripe Service Tests\n============================================================\n\nThese tests use a mock Stripe implementation to verify\nthe behavior of services/stripe.js without real API keys.\n\n\n=== createCheckoutSession Tests ===\n\n  [PASS] creates checkout session with valid inputs\n  [PASS] session URL is a valid Stripe checkout URL\n  [PASS] session ID has expected format\n  [PASS] creates customer for new user\n  [PASS] reuses existing customer for returning user\n  [PASS] updates user email\n  [PASS] throws error when price ID is missing\n  [PASS] throws error when price ID is empty string\n\n=== Webhook Signature Verification Tests ===\n\n  [PASS] verifies valid webhook signature\n  [PASS] throws on invalid signature format\n  [PASS] throws on empty signature\n  [PASS] throws on null signature\n  [PASS] parses event data correctly\n\n=== handleWebhook Tests ===\n\n  checkout.session.completed:\n  [PASS] activates subscription on checkout.session.completed\n  [PASS] updates user tier to paid on checkout completion\n  [PASS] sets stripe_customer_id on checkout completion\n  [PASS] sets stripe_subscription_id on checkout completion\n  [PASS] handles checkout without userId in metadata\n\n  customer.subscription.updated:\n  [PASS] keeps tier as paid when subscription is active\n  [PASS] downgrades tier to free when subscription is canceled\n  [PASS] downgrades tier to free when subscription is unpaid\n  [PASS] downgrades tier to free when subscription is past_due\n  [PASS] returns success for subscription updated\n\n  customer.subscription.deleted:\n  [PASS] resets tier to free on subscription deleted\n  [PASS] clears subscription ID on subscription deleted\n  [PASS] returns success for subscription deleted\n\n  invoice.payment_failed:\n  [PASS] records payment failure\n\n  Unknown events:\n  [PASS] handles unknown event types gracefully\n  [PASS] includes event type in unhandled message\n\n=== getSubscriptionStatus Tests ===\n\n  [PASS] returns null status for user without subscription\n  [PASS] returns correct tier for user without subscription\n  [PASS] returns subscription details for user with subscription\n  [PASS] includes currentPeriodEnd for active subscription\n  [PASS] includes cancelAtPeriodEnd flag\n  [PASS] handles subscription not found gracefully\n\n=== cancelSubscription Tests ===\n\n  [PASS] throws error when customer ID is missing\n  [PASS] throws error when customer ID is empty\n  [PASS] returns failure when no active subscription exists\n  [PASS] cancels subscription at period end\n  [PASS] returns cancel date in ISO format\n\n=== User Management Tests ===\n\n  [PASS] getUser creates new user if not exists\n  [PASS] new user has default tier of free\n  [PASS] new user has null email\n  [PASS] new user has null stripe_customer_id\n  [PASS] new user has null stripe_subscription_id\n  [PASS] getUser returns same user on subsequent calls\n\n=== Missing Stripe Keys Tests ===\n\nDOCUMENTATION: Behavior when Stripe is not configured\n\n    When STRIPE_SECRET_KEY is not set:\n    - Stripe SDK initializes with undefined key\n    - API calls throw: \"Invalid API Key provided\"\n    - Service should catch this and return user-friendly error\n  [PASS] [DOC] STRIPE_SECRET_KEY missing: SDK throws authentication errors on API calls\n  [PASS] [DOC] STRIPE_PRICE_ID missing: createCheckoutSession throws descriptive error\n    When STRIPE_WEBHOOK_SECRET is not set:\n    - constructWebhookEvent throws: \"STRIPE_WEBHOOK_SECRET not configured\"\n    - Webhook events cannot be verified\n    - Server should return 500 to Stripe webhooks\n  [PASS] [DOC] STRIPE_WEBHOOK_SECRET missing: constructWebhookEvent throws error\n    When all Stripe keys are missing:\n    - /api/health returns stripeConfigured: false\n    - Checkout button should be disabled or show error\n    - Upgrade page should display configuration message\n  [PASS] [DOC] All keys missing: Health check reports stripeConfigured: false\n\n============================================================\nTest Summary\n============================================================\nPassed: 50\nFailed: 0\nTotal:  50\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "lib-supabase",
      "description": "Supabase Library Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 1254,
      "output": "[dotenv@17.2.3] injecting env (9) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops\n\n============================================================\nSupabase Library Tests (lib/supabase.js)\n============================================================\n\nConfiguration Status: CONFIGURED\n\n=== Module Loading Tests ===\n\n  [PASS] supabase module exports required functions\n  [PASS] createServerClient is a function\n  [PASS] getClientConfig is a function\n  [PASS] verifyToken is a function\n\n=== getClientConfig Tests ===\n\n  [PASS] getClientConfig returns an object\n  [PASS] getClientConfig returns url property\n  [PASS] getClientConfig returns anonKey property\n  [PASS] getClientConfig returns non-empty url when configured\n  [PASS] getClientConfig returns non-empty anonKey when configured\n  [PASS] getClientConfig does not expose sensitive values\n\n=== createServerClient Tests ===\n\n  [PASS] createServerClient returns a Supabase client when configured\n  [PASS] supabase singleton is not null when configured\n  [PASS] supabase client has auth property\n  [PASS] supabase client has from method for database queries\n  [PASS] supabase client has storage property\n  [PASS] createServerClient can be called multiple times\n\n=== verifyToken Tests ===\n\n  [PASS] verifyToken returns an object with user and error properties\n  [PASS] verifyToken returns error for invalid token when configured\n  [PASS] verifyToken handles empty token when configured\n  [PASS] verifyToken handles malformed JWT when configured\n\n=== Connection Tests (Supabase Configured) ===\n\n  [PASS] Connection to Supabase can be established\n  [PASS] Query to profiles table returns result structure\n  [PASS] Storage service is accessible\n  [PASS] Auth service is accessible\n\n=== Error Handling Tests ===\n\n  [PASS] Module handles missing environment variables gracefully\n  [PASS] verifyToken does not throw on unexpected input types\n  [PASS] getClientConfig does not throw on any state\n\n=== Security Tests ===\n\n  [PASS] getClientConfig only exposes public/safe values\n  [PASS] Environment variables are not directly exposed\n  [PASS] Client config is safe to send to browser\n\n=== Profile Query Tests ===\n\n  [PASS] Profile query structure is correct\n  [PASS] Profile query with non-existent ID returns null data\n  [PASS] Profile table has expected columns based on schema\n\n============================================================\nTest Summary\n============================================================\nPassed:  33\nFailed:  0\nSkipped: 0\nTotal:   33\n\nSupabase Configuration:\n  SUPABASE_URL:      Set\n  SUPABASE_ANON_KEY: Set\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "middleware-auth",
      "description": "Auth Middleware Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 99,
      "output": "============================================================\nAuthentication Middleware Tests\n============================================================\n\nTesting: middleware/auth.js\n  - authMiddleware: JWT extraction and verification\n  - requireAuth: Protected route enforcement\n  - requireUserCheck: Role/permission checking\n\n\n=== authMiddleware Tests ===\n\nNo Authorization Header:\n  [PASS] sets user to null when no auth header\n  [PASS] sets isAuthenticated to false when no auth header\n  [PASS] calls next() when no auth header\n\nMalformed Authorization Header:\nAuth: Malformed Authorization header\nAuth: Malformed Authorization header\nAuth: Malformed Authorization header\n  [PASS] handles header without Bearer prefix\n  [PASS] handles header with wrong prefix\n  [PASS] handles header with too many parts\n  [PASS] handles Bearer with empty token\n  [PASS] handles case-insensitive Bearer prefix\n\nValid Token:\n  [PASS] sets user from verified token\n  [PASS] sets isAuthenticated to true for valid token\n  [PASS] calls next() after successful auth\n\nInvalid/Expired Token:\nAuth: Token verification failed: Token expired\n  [PASS] handles token verification error gracefully\nAuth: Token verification failed: Invalid token\n  [PASS] handles invalid token error gracefully\nAuth: Token verification failed: Supabase not configured\n  [PASS] handles Supabase not configured error\n\nNull User Response:\n  [PASS] handles null user from verifyToken (no error)\n\n=== requireAuth Tests ===\n\nUnauthenticated Requests:\n  [PASS] returns 401 when isAuthenticated is false\n  [PASS] returns error message when unauthenticated\n  [PASS] does not call next() when unauthenticated\n  [PASS] returns 401 when user is null but isAuthenticated true\n  [PASS] returns 401 when user is undefined\n\nAuthenticated Requests:\n  [PASS] calls next() when authenticated\n  [PASS] does not set status when authenticated\n\n=== requireUserCheck Tests ===\n\nUnauthenticated Requests:\n  [PASS] returns 401 when not authenticated\n\nFailed Check:\n  [PASS] returns 403 when check fails\n  [PASS] returns custom error message when check fails\n  [PASS] uses default error message when none provided\n  [PASS] does not call next() when check fails\n\nPassed Check:\n  [PASS] calls next() when check passes\n  [PASS] does not set status when check passes\n\nVarious Check Functions:\n  [PASS] works with email domain check\n  [PASS] works with array includes check\n  [PASS] works with boolean property check\n\n=== Token Extraction Edge Cases ===\n\n  [PASS] extracts token correctly from \"Bearer <token>\"\n  [PASS] handles authorization header with lowercase bearer\n  [PASS] handles token with special characters\n  [PASS] handles empty authorization header\n  [PASS] handles authorization header with only Bearer\nAuth: Malformed Authorization header\n  [PASS] handles whitespace-only token\nAuth: Malformed Authorization header\n\n=== Integration-Style Tests ===\n\nFull Middleware Chain:\nAuth: Token verification failed: Invalid token\n  [PASS] authMiddleware + requireAuth: blocks unauthenticated\n  [PASS] authMiddleware + requireAuth: allows authenticated\n  [PASS] full chain with requireUserCheck: admin access\n  [PASS] full chain with requireUserCheck: non-admin denied\n\n============================================================\nTest Summary\n============================================================\nPassed: 42\nFailed: 0\nTotal:  42\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "middleware-ratelimit",
      "description": "Rate Limit Middleware Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 64,
      "output": "============================================================\nRate Limit Middleware Tests for Pimp My Epstein\n============================================================\n\n\n=== Tier Configuration Reference ===\n\nCurrent rate limit tiers:\n\n| Tier      | Limit    | Name       | Description                       |\n|-----------|----------|------------|-----------------------------------|\n| anonymous | 1        | Anonymous  | Try it once without signing up    |\n| free      | 3        | Free       | Sign up for 3 free generations    |\n| paid      | Unlimited | Pro        | Unlimited generations             |\n\nSpecial tiers (not in config):\n| admin     | Unlimited | Admin      | Bypass all rate limits (req.isAdmin) |\n\n\n=== getClientIP Tests (Secure Implementation) ===\n\n  [PASS] uses req.ip when available (Express trust proxy)\n  [PASS] ignores x-forwarded-for header directly (security)\n  [PASS] ignores x-real-ip header directly (security)\n  [PASS] falls back to socket.remoteAddress when req.ip not set\n  [PASS] returns req.ip over socket.remoteAddress\n  [PASS] returns \"unknown\" when no IP source available\n  [PASS] handles IPv6 addresses via req.ip\n  [PASS] Express trust proxy handles header parsing securely\n\n=== createRateLimitMiddleware Tests ===\n\n  [PASS] creates middleware function\n  [PASS] middleware accepts options\n  [PASS] uses default upgradeUrl when not specified\n  [PASS] uses custom upgradeUrl when specified\n\n=== Admin Rate Limit Bypass Tests ===\n\n[ADMIN] Rate limit bypassed for admin user\n  [PASS] admin users bypass rate limits\n[ADMIN] Rate limit bypassed for admin user\n  [PASS] admin bypass sets clientIP on request\n[ADMIN] Rate limit bypassed for admin user\n  [PASS] admin bypass ignores usage limits even at high counts\n\n=== Tier-Based Rate Limit Tests ===\n\n  [PASS] anonymous user allowed on first request\n  [PASS] anonymous user blocked after limit reached\n  [PASS] free user allowed within limit\n  [PASS] free user blocked at limit\n  [PASS] paid user always allowed (unlimited)\n  [PASS] paid user with extremely high usage still allowed\n\n=== Rate Limit Response Tests ===\n\n  [PASS] 429 response includes error field\n  [PASS] 429 response includes code field\n  [PASS] 429 response includes tier info\n  [PASS] 429 response includes limit and used\n  [PASS] 429 response includes resetAt timestamp\n  [PASS] 429 response includes upgrade message for anonymous\n  [PASS] 429 response includes upgrade message for free user\n\n=== Request Augmentation Tests ===\n\n  [PASS] attaches usage info to request\n  [PASS] attaches clientIP to request\n\n=== Profile Fetching Tests ===\n\n  [PASS] calls getProfile for authenticated users\n  [PASS] does not call getProfile for anonymous users\nError fetching profile for rate limit: Database connection failed\n  [PASS] handles getProfile errors gracefully\n\n=== simpleRateLimitMiddleware Tests ===\n\n  [PASS] creates middleware without options\n  [PASS] works for anonymous users\n\n=== Middleware Error Handling Tests ===\n\n  [PASS] continues on middleware errors\n\n============================================================\nTest Summary\n============================================================\nPassed: 36\nFailed: 0\nTotal:  36\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "integration",
      "description": "Integration Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 70,
      "output": "==================================================\nPimp My Epstein Integration Tests\n==================================================\n\n\n=== Auth Middleware Tests ===\n\nWarning: Supabase credentials not configured. Auth features disabled.\nWarning: Supabase service role key not configured. Profile operations will fail.\nauthMiddleware behavior:\n  ‚úì sets user to null when no auth header\nAuth: Malformed Authorization header\n  ‚úì sets user to null with malformed auth header\n  ‚úì sets user to null with empty token\nWarning: Supabase credentials not configured. Auth features disabled.\nAuth: Token verification failed: Supabase not configured\n  ‚úì handles Bearer token correctly (case insensitive)\n\nrequireAuth behavior:\n  ‚úì returns 401 when not authenticated\n  ‚úì calls next when authenticated\n\n=== Rate Limit Middleware Tests ===\n\ngetClientIP (Secure Implementation):\n  ‚úì uses req.ip when available (Express sets this)\n  ‚úì ignores x-forwarded-for header directly (security)\n  ‚úì falls back to socket.remoteAddress when req.ip not set\n  ‚úì returns unknown when no IP available\n\ncreateRateLimitMiddleware:\nRate limit middleware error: TypeError: Cannot read properties of undefined (reading 'bind')\n    at rateLimitMiddleware (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/middleware/rateLimit.js:96:37)\n    at /Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:253:11\n    at test (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:27:11)\n    at runRateLimitTests (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:235:9)\n    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at async main (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:732:5)\n  ‚úì allows request when under limit\n  ‚úì blocks request when at limit\nRate limit middleware error: TypeError: Cannot read properties of undefined (reading 'bind')\n    at rateLimitMiddleware (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/middleware/rateLimit.js:96:37)\n    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at async /Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:312:5\n    at async test (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:27:5)\n    at async runRateLimitTests (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:291:3)\n    at async main (/Users/jacquelineoliver/Documents/GitHub/slopdepot/epswag/tests/integration.test.js:732:5)\n  ‚úì allows paid user with high usage\n  ‚úì free user blocked at limit\n  ‚úì includes upgrade message in blocked response\n\n=== Full Flow Simulation Tests ===\n\nGeneration lifecycle:\n  ‚úì full generation success flow\n  ‚úì full generation failure flow\n  ‚úì usage tracking through generation\n\nGeneration history:\n  ‚úì tracks multiple generations per user\n  ‚úì separates generations by user\n\nTier upgrade scenarios:\n  ‚úì user gains more generations after upgrade\n  ‚úì anonymous converts to free user\n\n=== Error Handling Integration Tests ===\n\nError code propagation:\n  ‚úì NO_FACE error is stored and retrievable\n  ‚úì TIMEOUT error is stored correctly\n  ‚úì generation history includes failed attempts\n\nConcurrent request handling:\n  ‚úì multiple simultaneous generations tracked correctly\n\n=== Edge Case Tests ===\n\nBoundary conditions:\n  ‚úì free user at exactly limit-1 can generate\n  ‚úì generation with very long epsteinPhoto path\n  ‚úì generation with special characters in path\n  ‚úì handles rapid sequential generations\n  ‚úì getGenerations with limit larger than available\n  ‚úì getGenerations with limit of 0\n\nNull/undefined handling:\n  ‚úì completeGeneration with null id returns null\n  ‚úì failGeneration with null id returns null\n  ‚úì getGeneration with null id returns null\n  ‚úì checkUsage handles all null params\n\n==================================================\nTest Summary\n==================================================\nPassed: 36\nFailed: 0\nTotal:  36\n\nAll tests passed!\n",
      "passed": 36,
      "failed": 0
    },
    {
      "name": "error-handling",
      "description": "Error Handling Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 345,
      "output": "============================================================\nError Handling Tests - Pimp My Epstein\n============================================================\nTesting against: http://localhost:3000\n\nServer is running.\n\n\n--- Invalid JSON Body Tests ---\n  [PASS] POST with malformed JSON returns 400\n  [PASS] malformed JSON error has error field\n  [PASS] empty body with JSON content-type is handled\n\n--- Missing Required Fields Tests ---\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] /api/generate without userPhoto returns 400 or 429\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] /api/generate without epsteinPhoto returns 400 or 429 with descriptive message\n  [PASS] /api/admin/login without password returns 400 or 429\n  [PASS] /api/create-checkout without auth returns 401 or 429\n\n--- Invalid File Type Tests ---\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] uploading text file as image returns 400 or 429\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] uploading PDF as image returns 400 or 429 with clear message\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] uploading GIF returns 400 or 429 (only JPEG/PNG/WebP allowed)\n  [PASS] error message for invalid file type is user-friendly\n\n--- Rate Limit Tests ---\n  [PASS] rate limit response includes 429 status\n  [PASS] rate limit error has proper structure\n  [PASS] rate limit errors do not expose sensitive info\n\n--- Authentication Failure Tests ---\n  [PASS] /api/generations returns 401 without auth\n  [PASS] /api/subscription returns 401 without auth\n  [PASS] /api/cancel-subscription returns 401 without auth\n  [PASS] invalid Bearer token returns 401 for protected routes\n  [PASS] malformed Authorization header is handled gracefully\n  [PASS] empty Bearer token is handled\n  [PASS] 401 errors have proper message structure\n  [PASS] 401 errors do not expose sensitive information\n  [PASS] /api/admin/debug returns 401 without admin token\n  [PASS] /api/admin/login with wrong password returns 401, 429, or config error\n\n--- Server Error Tests ---\n  [PASS] 500 errors do not expose file paths\n  [PASS] 500 errors do not expose stack traces\n  [PASS] 500 errors do not expose environment variables\n  [PASS] error responses have consistent structure\n\n--- Path Traversal Protection Tests ---\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] path traversal in epsteinPhoto is blocked\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] absolute paths in epsteinPhoto are blocked\n  [PASS] /output/:filename path traversal is blocked\n\n--- CORS Handling Tests ---\n  [PASS] OPTIONS request returns proper CORS headers\n  [PASS] API endpoints include Content-Type header\n\n--- Webhook Error Handling Tests ---\n  [PASS] Stripe webhook without signature returns 400\n  [PASS] Stripe webhook with invalid signature returns 400\n\n--- Input Validation Tests ---\n  [PASS] oversized file returns 400 with clear message\n    (Note: Rate limited - expected behavior when running many tests)\n  [PASS] image with valid MIME but invalid content returns error\n  [PASS] SQL injection attempts in query params are handled safely\n  [PASS] XSS attempts in input are not reflected in error messages\n\n============================================================\nTest Summary\n============================================================\nPassed: 39\nFailed: 0\nTotal:  39\n\nNOTE: Some tests encountered rate limiting (429).\nThis is expected behavior - the server protects against abuse.\nRestart server to reset rate limits if testing again.\n\nAll tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-rate-limit",
      "description": "Rate Limit Security Tests",
      "status": "failed",
      "exitCode": 1,
      "duration": 861,
      "output": "============================================================\nPimp My Epstein - Security Rate Limit Tests\n============================================================\nTesting against: http://localhost:3000\nTime: 2025-12-29T04:40:56.209Z\n\nServer is running and responding.\n\n\n=== Rate Limit Header Tests ===\n\nVerifying X-RateLimit-* headers are returned by rate-limited endpoints.\n\nGlobal Generate Endpoint (/api/generate):\n       RateLimit-Limit: 100\n       RateLimit-Remaining: 0\n  [PASS] generate endpoint returns RateLimit-Limit header\n       RateLimit-Remaining: 0\n  [PASS] generate endpoint returns RateLimit-Remaining header\n\nAdmin Login Endpoint (/api/admin/login):\n       RateLimit-Limit: 5\n       RateLimit-Remaining: 0\n  [PASS] admin login returns rate limit headers\n\nCheckout Endpoint (/api/create-checkout):\n       RateLimit-Limit: 10\n       RateLimit-Remaining: 0\n  [PASS] checkout endpoint returns rate limit headers\n\n=== Global Generate Rate Limit Tests ===\n\nTesting: 100 requests/hour limit across all users\nWARNING: These tests consume rate limit quota!\n\n       Note: Rate limit already reached from previous tests\n       Error: Service temporarily at capacity. Please try again later.\n  [PASS] initial requests do not trigger rate limit\n       Remaining values: 0 -> 0 -> 0\n  [PASS] rate limit decrements with each request\n\n=== Suspicious IP Blocking Tests ===\n\nTesting: Block IP after >10 requests in 5 minutes\nNOTE: This uses in-memory tracking, not express-rate-limit\n\n  [PASS] suspicious activity tracking is active\n       Successful: 0, Rate Limited: 0\n  [PASS] rapid requests are tracked (non-blocking test)\n       Behavior: IPs making >10 requests in 5 min are blocked\n       Response: 429 with RATE_LIMITED code\n       Cleanup: Old entries removed after 1 hour\n  [FAIL] suspicious IP blocking documented behavior\n         Error: Rate limit response should include code\n\n=== Admin Login Rate Limit Tests ===\n\nTesting: 5 attempts per 15 minutes\nWARNING: These tests consume admin login quota!\n\n       Note: Rate limit already reached\n  [PASS] admin login endpoint exists\n       RateLimit-Remaining: 0\n       Rate limit message: Too many login attempts, please try again later\n  [PASS] failed login attempts are tracked\n       Window: 15 minutes\n       Limit: 5 attempts\n       Reset: After window expires, counter resets to 0\n  [PASS] rate limit resets after window (documentation)\n\n=== Checkout Rate Limit Tests ===\n\nTesting: 10 attempts per 15 minutes\nWARNING: These tests consume checkout quota!\n\n       Note: Rate limit already reached\n  [PASS] checkout endpoint exists\n       RateLimit-Limit: 10\n  [PASS] checkout rate limit headers are returned\n       Remaining values: 0 -> 0 -> 0\n  [PASS] repeated checkout attempts consume quota\n\n=== Rate Limit Bypass Tests (Admin) ===\n\nVerifying admin users can bypass rate limits.\n\n       Admin configured: true\n       Is admin: false\n  [PASS] admin status endpoint works\n  [PASS] non-admin requests are subject to rate limits\n\n=== Rate Limit Error Response Format Tests ===\n\nVerifying error responses follow consistent format.\n\n       Error message: Too many login attempts, please try again later\n  [PASS] rate limit error includes required fields\n       Expected fields in tier-based rate limit:\n         - error: string\n         - code: \"RATE_LIMITED\"\n         - tier: \"anonymous\"|\"free\"|\"paid\"\n         - tierName: string\n         - limit: number\n         - used: number\n         - remaining: 0\n         - upgradeUrl: string\n         - message: string\n  [PASS] per-user rate limit includes upgrade info\n\n=== Rate Limit Implementation Summary ===\n\n1. GLOBAL GENERATE LIMITER\n   -------------------------\n   Endpoint: POST /api/generate\n   Limit: 100 requests per hour (across ALL users)\n   Purpose: Prevent API key exhaustion/abuse\n   Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset\n   Response: 429 with { error: \"Service temporarily at capacity...\" }\n\n2. SUSPICIOUS IP BLOCKING\n   -----------------------\n   Endpoint: POST /api/generate\n   Limit: >10 requests in 5 minutes = IP blocked\n   Purpose: Detect and block abuse patterns\n   Storage: In-memory Map (suspiciousIPs)\n   Cleanup: Entries older than 1 hour are removed\n   Response: 429 with { error: \"Too many requests from your IP...\", code: \"RATE_LIMITED\" }\n\n3. ADMIN LOGIN LIMITER\n   -------------------\n   Endpoint: POST /api/admin/login\n   Limit: 5 attempts per 15 minutes\n   Purpose: Prevent brute force password attacks\n   Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset\n   Response: 429 with { error: \"Too many login attempts, please try again later\" }\n\n4. CHECKOUT LIMITER\n   -----------------\n   Endpoint: POST /api/create-checkout\n   Limit: 10 attempts per 15 minutes\n   Purpose: Prevent payment/checkout abuse\n   Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset\n   Response: 429 with { error: \"Too many checkout attempts, please try again later\" }\n\n5. PER-USER TIER-BASED LIMITS\n   --------------------------\n   Endpoint: POST /api/generate\n   Limits:\n     - Anonymous: 1 generation\n     - Free (signed up): 3 generations\n     - Paid ($20/mo): Unlimited\n     - Admin: Unlimited (bypass all limits)\n   Purpose: Monetization & fair usage\n   Response: 429 with detailed upgrade info\n\nIMPORTANT NOTES:\n  - Rate limits use express-rate-limit with standardHeaders: true\n  - Admin users (valid admin token) bypass all rate limits\n  - Suspicious IP tracking persists in memory only (resets on server restart)\n  - Rate limit windows are rolling (based on first request in window)\n\n============================================================\nTest Summary\n============================================================\nPassed: 18\nFailed: 1\nTotal:  19\n\nFailed Tests:\n  - suspicious IP blocking documented behavior: Rate limit response should include code\n\nNote: Some failures may be due to rate limits from previous test runs.\nWait 15-60 minutes for rate limits to reset and run again.\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-payment-auth",
      "description": "Payment Auth Security Tests",
      "status": "failed",
      "exitCode": 1,
      "duration": 362,
      "output": "============================================================\nPayment Endpoint Authentication Security Tests\n============================================================\nTesting against: http://localhost:3000\n\nENDPOINTS REQUIRING AUTHENTICATION:\n  - POST /api/create-checkout\n  - GET  /api/subscription\n  - POST /api/cancel-subscription\n\nSECURITY FIX VERIFICATION:\n  - All endpoints return 401 without valid Supabase auth token\n  - User ID is taken from session, not request body\n  - Prevents IDOR attacks on payment operations\n\nServer is running. Starting tests...\n\n\n--- POST /api/create-checkout ---\n\n  [PASS] returns 401 without auth token\n  [PASS] returns 401 with invalid auth token\n  [PASS] returns 401 with malformed auth header\n  [PASS] returns 401 with empty Bearer token\n  [FAIL] error message indicates authentication required\n    Error: Expected error to mention authentication\n\n--- GET /api/subscription ---\n\n  [PASS] returns 401 without auth token\n  [PASS] returns 401 even with userId in query param (no auth bypass)\n  [PASS] returns 401 with invalid auth token\n  [PASS] error message indicates authentication required\n\n--- POST /api/cancel-subscription ---\n\n  [PASS] returns 401 without auth token\n  [PASS] returns 401 with invalid auth token\n  [PASS] cannot bypass auth by supplying customerId in body\n  [PASS] error message indicates authentication required\n\n--- Additional Security Verifications ---\n\n  [PASS] /api/generations requires auth (consistent with payment endpoints)\n  [PASS] /api/me works without auth (returns anonymous user info)\n  [PASS] /api/config works without auth\n  [PASS] /api/photos works without auth\n  [PASS] /api/health works without auth\n\n============================================================\nTest Summary\n============================================================\nPassed: 17\nFailed: 1\nTotal:  18\n\nFailed Tests:\n  - error message indicates authentication required: Expected error to mention authentication\n\nSECURITY WARNING: Some authentication checks are failing!\nThis may indicate a security vulnerability in payment endpoints.\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-file-upload",
      "description": "File Upload Security Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 4155,
      "output": "============================================================\nSecurity Tests: File Upload Validation\n============================================================\nTesting against: http://localhost:3000\n\nNOTE: Rate limiting is 10 requests per 5 minutes.\n      Tests are optimized to fit within this limit.\n\nUsing Epstein photo: /epstein-photos/epstein_bill_silk.jpg\n\n\n=== Critical Security Tests ===\n\nTesting the most important security validations.\n\n  [SKIP] rejects non-image MIME type (GIF) (rate limited)\n  [SKIP] rejects EXE disguised as PNG (magic byte check) (rate limited)\n  [SKIP] rejects PDF disguised as JPEG (magic byte check) (rate limited)\n  [SKIP] rejects HTML disguised as PNG (XSS prevention) (rate limited)\n  [SKIP] rejects truncated/malformed PNG (rate limited)\n  [SKIP] rejects empty file (rate limited)\n  [SKIP] rejects path traversal in epsteinPhoto parameter (rate limited)\n  [SKIP] rejects absolute path in epsteinPhoto (rate limited)\n  [SKIP] valid PNG format accepted (rejected for dimension) (rate limited)\n\n============================================================\nSecurity Test Summary\n============================================================\nPassed:  0\nFailed:  0\nSkipped: 9 (rate limited)\nTotal:   9\n\nSkipped Tests (rate limited):\n  - rejects non-image MIME type (GIF)\n  - rejects EXE disguised as PNG (magic byte check)\n  - rejects PDF disguised as JPEG (magic byte check)\n  - rejects HTML disguised as PNG (XSS prevention)\n  - rejects truncated/malformed PNG\n  - rejects empty file\n  - rejects path traversal in epsteinPhoto parameter\n  - rejects absolute path in epsteinPhoto\n  - valid PNG format accepted (rejected for dimension)\n\nSome tests were skipped due to rate limiting.\nRestart the server and re-run to complete all tests.\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-admin-cookie",
      "description": "Admin Cookie Security Tests",
      "status": "failed",
      "exitCode": 1,
      "duration": 133,
      "output": "============================================================\nAdmin Cookie Security Tests - Pimp My Epstein\n============================================================\nTesting against: http://localhost:3000\nCookie jar: /var/folders/bx/1yd3_qhd2w78_xys_zp77fnw0000gn/T/epswag-test-cookies-1766983261622.txt\n\nNOTE: Tests are optimized to minimize login attempts\n(Rate limit: 5 attempts per 15 minutes)\n\nServer is running and healthy\nAdmin mode is configured\n\n\n--- Initial Login (creates shared session) ---\n\nERROR: Rate limited by server. Wait 15 minutes and try again.\nThe admin login rate limiter allows 5 attempts per 15 minutes.\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-path-traversal",
      "description": "Path Traversal Security Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 104,
      "output": "============================================================\nPath Traversal Security Tests - Pimp My Epstein\n============================================================\nTesting against: http://localhost:3000\n\nServer is running and responding.\n\n\n=== Path Traversal Security Tests ===\n\nUsing valid photo path for comparison: /epstein-photos/epstein_bill_silk.jpg\n\nBasic Path Traversal Attacks:\n  [PASS] blocks ../../.env traversal\n  [PASS] blocks ../package.json traversal\n  [PASS] blocks /../../../etc/passwd traversal\n  [PASS] blocks /epstein-photos/../.env traversal\n  [PASS] blocks /epstein-photos/../../.env traversal\n\nURL-Encoded Path Traversal Attacks:\n  [PASS] blocks %2e%2e%2f.env (URL-encoded ../)\n  [PASS] blocks %2e%2e%2f%2e%2e%2f.env (double URL-encoded)\n  [PASS] blocks ..%2f.env (mixed encoding)\n  [PASS] blocks %2e%2e/.env (partial encoding)\n  [PASS] blocks %252e%252e%252f.env (double URL-encoding)\n\nNull Byte Injection Attacks:\n  [PASS] blocks path%00.jpg null byte injection\n  [PASS] blocks path with literal null byte\n  [PASS] blocks /epstein-photos/photo.jpg%00../../.env\n\nWindows-Style Path Traversal:\n  [PASS] blocks ..\\..\\file.txt (backslash traversal)\n  [PASS] blocks ..%5c..%5c.env (URL-encoded backslash)\n\nAbsolute Path Attempts:\n  [PASS] blocks /etc/passwd absolute path\n  [PASS] blocks C:\\Windows\\System32\\config\\SAM\n\nValid Photo Path Tests:\n  [PASS] accepts valid photo path with leading slash\n  [PASS] accepts valid photo path without leading slash\n\nEdge Cases:\n  [PASS] blocks empty string path\n  [PASS] blocks path with only dots\n  [PASS] blocks path with spaces and traversal\n  [PASS] blocks non-existent valid-looking path\n  [PASS] blocks path with unicode characters\n\nServer File Access Prevention:\n  [PASS] blocks access to server.js\n  [PASS] blocks access to package.json\n  [PASS] blocks access to node_modules\n\n=== Output File Access Security Tests ===\n\nOutput Directory Path Traversal:\n  [PASS] blocks ../server.js via output endpoint\n  [PASS] blocks %2e%2e%2fserver.js via output endpoint\n  [PASS] blocks ..%00.png via output endpoint\n\n============================================================\nSecurity Test Summary\n============================================================\nPassed: 30\nFailed: 0\nTotal:  30\n\nAll security tests passed!\nThe path traversal protection appears to be working correctly.\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-cors",
      "description": "CORS Security Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 236,
      "output": "\n============================================================\nCORS Security Tests\n============================================================\nTesting against: http://localhost:3000\n\n\n[1] Production Origins (pimpmyepstein.lol):\n  [PASS] https://pimpmyepstein.lol is ALLOWED\n  [PASS] https://www.pimpmyepstein.lol is ALLOWED\n\n[2] Development Origins (localhost):\n    Note: Got Access-Control-Allow-Origin: not set\n    This may indicate NODE_ENV is not set to 'development'\n  [PASS] http://localhost:3000 is ALLOWED (dev mode)\n    Note: Got Access-Control-Allow-Origin: not set\n  [PASS] http://127.0.0.1:3000 is ALLOWED (dev mode)\n\n[3] Malicious Origins (should be BLOCKED):\n  [PASS] https://evil-site.com is BLOCKED\n  [PASS] https://attacker.com is BLOCKED\n  [PASS] https://pimpmyepstein.lol.evil.com is BLOCKED (subdomain attack)\n  [PASS] https://fakepimpmyepstein.lol is BLOCKED\n  [PASS] http://pimpmyepstein.lol is BLOCKED (http not https)\n\n[4] No Origin Header:\n  [PASS] Request without Origin header succeeds (for curl/Postman/mobile)\n\n[5] Preflight OPTIONS Requests:\n  [PASS] OPTIONS preflight for pimpmyepstein.lol succeeds\n  [PASS] OPTIONS preflight for evil-site.com is BLOCKED\n  [PASS] OPTIONS preflight includes credentials header\n  [PASS] OPTIONS preflight allows required headers\n\n[6] CORS on Various Endpoints:\n  [PASS] /api/health allows pimpmyepstein.lol\n  [PASS] /api/health blocks evil-site.com\n  [PASS] /api/photos allows pimpmyepstein.lol\n  [PASS] /api/photos blocks evil-site.com\n  [PASS] /api/config allows pimpmyepstein.lol\n  [PASS] /api/config blocks evil-site.com\n  [PASS] /api/me allows pimpmyepstein.lol\n  [PASS] /api/me blocks evil-site.com\n\n============================================================\nCORS Configuration Analysis\n============================================================\n\nAllowed Origins (from server.js):\n  - https://pimpmyepstein.lol\n  - https://www.pimpmyepstein.lol\n  - http://localhost:3000 (development only)\n  - http://127.0.0.1:3000 (development only)\n\nCORS Settings:\n  - credentials: true (allows cookies)\n  - methods: GET, POST, OPTIONS\n  - allowedHeaders: Content-Type, Authorization, X-Admin-Token\n\nNo-Origin Handling:\n  - Development: Allowed (for curl, Postman, mobile apps)\n  - Production: Blocked (Origin header required)\n\nSecurity Notes:\n  - HTTP (non-HTTPS) origins are NOT allowed\n  - Subdomains are NOT automatically allowed\n  - Similar-looking domains are NOT allowed\n\n============================================================\nTest Summary\n============================================================\nPassed: 22\nFailed: 0\nTotal:  22\n\nOrigins BLOCKED (as expected):\n  - https://evil-site.com\n  - https://attacker.com\n  - https://pimpmyepstein.lol.evil.com\n  - https://fakepimpmyepstein.lol\n  - http://pimpmyepstein.lol (http, not https)\n\nOrigins ALLOWED:\n  - https://pimpmyepstein.lol\n  - https://www.pimpmyepstein.lol\n  - http://localhost:3000 (dev mode)\n  - http://127.0.0.1:3000 (dev mode)\n\nAll CORS security tests passed!\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-headers",
      "description": "Security Headers Tests",
      "status": "failed",
      "exitCode": 1,
      "duration": 278,
      "output": "\n========================================\n SECURITY HEADERS TESTS\n========================================\n\nTesting against: http://localhost:3000\n\n--- All Security Headers Found on / ---\n\nRaw headers from curl -I:\n\nHTTP/1.1 200 OK\r\nContent-Security-Policy: default-src 'self';script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;font-src 'self' https://fonts.gstatic.com;img-src 'self' data: blob: https:;connect-src 'self' https://*.supabase.co https://api.stripe.com;frame-ancestors 'none';base-uri 'self';form-action 'self';object-src 'none';script-src-attr 'none';upgrade-insecure-requests\r\nCross-Origin-Opener-Policy: same-origin\r\nCross-Origin-Resource-Policy: same-origin\r\nOrigin-Agent-Cluster: ?1\r\nReferrer-Policy: no-referrer\r\nX-Content-Type-Options: nosniff\r\nX-DNS-Prefetch-Control: off\r\nX-Download-Options: noopen\r\nX-Frame-Options: DENY\r\nX-Permitted-Cross-Domain-Policies: none\r\nX-XSS-Protection: 0\r\nAccept-Ranges: bytes\r\nCache-Control: public, max-age=0\r\nLast-Modified: Sun, 28 Dec 2025 23:52:10 GMT\r\nETag: W/\"17742-19b67606819\"\r\nContent-Type: text/html; charset=utf-8\r\nContent-Length: 96066\r\nDate: Mon, 29 Dec 2025 04:41:02 GMT\r\nConnection: keep-alive\r\nKeep-Alive: timeout=5\r\n\r\n\n\n\n--- Test 1: X-Frame-Options ---\n  [PASS] / has X-Frame-Options header\n  [PASS] /api/health has X-Frame-Options header\n  [PASS] /api/photos has X-Frame-Options header\n  [PASS] /api/config has X-Frame-Options header\n\n  Note: Current implementation uses SAMEORIGIN (Helmet default)\n        Requirement was DENY - this is a minor deviation.\n\n--- Test 2: X-Content-Type-Options ---\n  [PASS] / has X-Content-Type-Options: nosniff\n  [PASS] /api/health has X-Content-Type-Options: nosniff\n  [PASS] /api/photos has X-Content-Type-Options: nosniff\n  [PASS] /api/config has X-Content-Type-Options: nosniff\n\n--- Test 3: X-XSS-Protection ---\n  [PASS] / has X-XSS-Protection header\n  [PASS] /api/health has X-XSS-Protection header\n  [PASS] /api/photos has X-XSS-Protection header\n  [PASS] /api/config has X-XSS-Protection header\n\n  Note: Current implementation uses X-XSS-Protection: 0\n        Requirement was \"1; mode=block\" but modern best practice\n        is to disable it as it can introduce XSS vulnerabilities.\n\n--- Test 4: Content-Security-Policy ---\n  [PASS] / has Content-Security-Policy header\n  [PASS] /api/health has Content-Security-Policy header\n  [PASS] /api/photos has Content-Security-Policy header\n  [PASS] /api/config has Content-Security-Policy header\n  [PASS] CSP includes frame-ancestors directive\n  [PASS] CSP includes connect-src for API connections\n  [PASS] CSP includes object-src none\n\n--- Test 5: Strict-Transport-Security (HSTS) ---\n  [FAIL] Root endpoint has Strict-Transport-Security header\n         Error: Strict-Transport-Security header missing\n  [PASS] HSTS includes includeSubDomains\n\n  Note: HSTS is present even in development mode in current config.\n        In production, it enforces HTTPS with 1-year max-age.\n\n--- Test 6: X-Powered-By Should Be ABSENT ---\n  [PASS] / does NOT have X-Powered-By header\n  [PASS] /api/health does NOT have X-Powered-By header\n  [PASS] /api/photos does NOT have X-Powered-By header\n  [PASS] /api/config does NOT have X-Powered-By header\n\n--- Additional Security Headers (Bonus) ---\n  [PASS] Cross-Origin-Opener-Policy is set\n  [PASS] Cross-Origin-Resource-Policy is set\n  [PASS] Referrer-Policy is set\n  [PASS] X-DNS-Prefetch-Control is set\n  [PASS] X-Download-Options is set\n  [PASS] X-Permitted-Cross-Domain-Policies is set\n\n========================================\n TEST SUMMARY\n========================================\n\nTotal Tests: 31\nPassed: 30\nFailed: 1\n\nFailed Tests:\n  - Root endpoint has Strict-Transport-Security header\n    Strict-Transport-Security header missing\n\n========================================\n ALL SECURITY HEADERS DOCUMENTED\n========================================\n\nHeaders present in responses:\n\n  x-frame-options:\n    Value: DENY\n    Purpose: Prevents clickjacking by controlling if page can be framed\n\n  x-content-type-options:\n    Value: nosniff\n    Purpose: Prevents MIME type sniffing attacks\n\n  x-xss-protection:\n    Value: 0\n    Purpose: Controls browser XSS filter (deprecated, set to 0)\n\n  content-security-policy:\n    Value: default-src 'self';script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;st...\n    Purpose: Controls which resources can be loaded\n\n  cross-origin-opener-policy:\n    Value: same-origin\n    Purpose: Isolates browsing context from cross-origin documents\n\n  cross-origin-resource-policy:\n    Value: same-origin\n    Purpose: Controls cross-origin resource loading\n\n  referrer-policy:\n    Value: no-referrer\n    Purpose: Controls referrer information in requests\n\n  x-dns-prefetch-control:\n    Value: off\n    Purpose: Controls DNS prefetching\n\n  x-download-options:\n    Value: noopen\n    Purpose: Prevents IE from executing downloads in site context\n\n  x-permitted-cross-domain-policies:\n    Value: none\n    Purpose: Controls Adobe Flash cross-domain access\n\n  origin-agent-cluster:\n    Value: ?1\n    Purpose: Requests that origin be keyed on agent cluster\n\nHeaders that SHOULD be absent:\n\n  x-powered-by: ABSENT (GOOD)\n\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "security-output-access",
      "description": "Output Access Security Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 482,
      "output": "============================================================\nSecurity Tests: Output Image Access Control\n============================================================\nTesting against: http://localhost:3000\n\nServer is running and healthy.\n\n\n=== Direct Output Access Tests ===\n\nTesting that /output is not served statically:\n  ‚úì direct access to /output/filename without auth returns 403 or 404\n  ‚úì direct access returns JSON error, not image\n  ‚úì error response includes access denied message\n  ‚úì path traversal attempt is blocked\n  ‚úì path traversal with encoded chars is blocked\n  ‚úì double dot in filename is rejected\n\n=== Authenticated Output Access Tests ===\n\nTesting access control for authenticated users:\n  ‚úì unauthenticated request to existing output returns 403\n  ‚úì invalid bearer token still returns 403 for output\n  ‚úì malformed authorization header is handled gracefully\n\n=== Admin Output Access Tests ===\n\n  [Skip] ADMIN_PASSWORD not set - admin tests will be skipped\nSkipping admin tests (ADMIN_PASSWORD not set or login failed)\n    Skipped - ADMIN_PASSWORD not configured\n  ‚úì [SKIP] Admin can access any image\n\n=== View Token Access Tests ===\n\nTesting viewToken-based access for anonymous generations:\n  ‚úì output request without viewToken returns 403\n  ‚úì output request with invalid viewToken returns 403\n  ‚úì viewToken must match the generation record\n  ‚úì short viewToken is rejected\n\n=== Generation API Access Tests ===\n\nTesting /api/generation/:id access control:\n  ‚úì non-existent generation returns 404\n  ‚úì generation API requires viewToken for anonymous generations\n  ‚úì generations list requires authentication\n  ‚úì generations list rejects invalid auth\n\n=== Security Header Tests ===\n\nTesting security headers on output responses:\n  ‚úì error responses have proper content-type\n  ‚úì X-Content-Type-Options header is set\n  ‚úì X-Frame-Options header is set\n  ‚úì referrer policy is set\n\n=== CORS Tests for Output Endpoint ===\n\nTesting CORS protection on output images:\n  ‚úì output endpoint blocks evil-site.com origin in production mode\n  ‚úì preflight OPTIONS request is handled\n\n=== Edge Case Tests ===\n\nTesting edge cases and malformed requests:\n  ‚úì empty filename is handled\n  ‚úì special characters in filename are handled\n  ‚úì extremely long filename is handled\n  ‚úì non-image extension is handled\n  ‚úì query string injection is handled\n\n=== Legacy Image Access Tests ===\n\nTesting access to images without generation records:\n  ‚úì images without generation records return 403\n  ‚úì error message indicates missing authorization\n\n=== Integration Tests: End-to-End Access Flow ===\n\nTesting the complete access control flow:\n  ‚úì accessing output without any credentials fails\n  ‚úì generation endpoint requires authentication for history\n  ‚úì individual generation access requires valid viewToken or auth\n  ‚úì API security headers are consistent across endpoints\n  ‚úì concurrent access attempts are all blocked\n\n============================================================\nTest Summary\n============================================================\nPassed: 36\nFailed: 0\nTotal:  36\n\nAll tests passed!\n\nAccess Control Verified:\n  - Direct /output access is blocked without auth\n  - Path traversal attacks are prevented\n  - Admin authentication grants full access\n  - Anonymous access requires valid viewToken\n  - Legacy images without generation records are blocked\n",
      "passed": 36,
      "failed": 0
    },
    {
      "name": "api",
      "description": "API Endpoint Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 116,
      "output": "==================================================\nPimp My Epstein API Tests\n==================================================\nTesting against: http://localhost:3000\n\n\n=== API Endpoint Tests ===\n\nHealth Check (/api/health):\n  ‚úì returns 200 OK status\n  ‚úì returns JSON with status field\n  ‚úì includes apiKeySet boolean\n  ‚úì includes stripeConfigured boolean\n  ‚úì includes supabaseConfigured boolean\n  ‚úì includes epsteinPhotosCount number\n  ‚úì includes anonymousUsersTracked number\n\nPhotos Gallery (/api/photos):\n  ‚úì returns 200 OK status\n  ‚úì returns JSON with photos array\n  ‚úì each photo has required fields\n  ‚úì photo paths are valid URL format\n\nConfig (/api/config):\n  ‚úì returns 200 OK status\n  ‚úì returns supabase configuration\n  ‚úì returns tiers array\n  ‚úì tiers include anonymous, free, and paid\n  ‚úì each tier has required fields\n\nMe (/api/me):\n  ‚úì returns 200 OK for anonymous user\n  ‚úì anonymous user has authenticated=false\n  ‚úì anonymous user has null user object\n  ‚úì anonymous user has usage object\n  ‚úì anonymous user tier is \"anonymous\"\n\nError Handling:\n  ‚úì 404 for non-existent endpoint\n  ‚úì generate endpoint requires userPhoto\n  ‚úì generate endpoint requires epsteinPhoto\n\nGenerations (/api/generations):\n  ‚úì returns 401 for unauthenticated request\n  ‚úì returns error message for unauthenticated request\n\nGeneration by ID (/api/generation/:id):\n  ‚úì returns 404 for non-existent generation\n\nSubscription (/api/subscription):\n  ‚úì returns 401 without auth (requires authentication)\n\nCheckout (/api/create-checkout):\n  ‚úì returns 401 without auth (requires authentication)\n  ‚úì returns 401 even with userId/email (auth required, not body params)\n\nCancel Subscription (/api/cancel-subscription):\n  ‚úì returns 401 without auth (requires authentication)\n\n=== Rate Limiting Tests ===\n\nRate Limiting Behavior:\n  ‚úì anonymous users start with 1 generation limit\n  ‚úì usage info is included in responses\n\n==================================================\nTest Summary\n==================================================\nPassed: 33\nFailed: 0\nTotal:  33\n\nAll tests passed!\n",
      "passed": 33,
      "failed": 0
    },
    {
      "name": "api-functionality",
      "description": "API Functionality Tests",
      "status": "passed",
      "exitCode": 0,
      "duration": 106,
      "output": "\n============================================================\n\u001b[1mAPI Functionality Tests - Pimp My Epstein\u001b[0m\n============================================================\nTesting against: http://localhost:3000\n\n\u001b[32mServer is running\u001b[0m\n\n\n\u001b[1m=== 1. GET /api/health ===\u001b[0m\n\u001b[33mPurpose: Server health check and configuration status\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns HTTP 200 OK\n       \u001b[36mExpected:\u001b[0m HTTP status code 200\n       \u001b[36mActual:\u001b[0m   200\n  \u001b[32mPASS\u001b[0m Returns JSON content type\n       \u001b[36mExpected:\u001b[0m Content-Type: application/json\n       \u001b[36mActual:\u001b[0m   application/json\n  \u001b[32mPASS\u001b[0m Response contains status: \"ok\"\n       \u001b[36mExpected:\u001b[0m status field equals \"ok\"\n       \u001b[36mActual:\u001b[0m   ok\n  \u001b[32mPASS\u001b[0m Response contains apiKeySet boolean\n       \u001b[36mExpected:\u001b[0m apiKeySet is boolean (true if GEMINI_API_KEY is set)\n       \u001b[36mActual:\u001b[0m   apiKeySet: true\n  \u001b[32mPASS\u001b[0m Response contains stripeConfigured boolean\n       \u001b[36mExpected:\u001b[0m stripeConfigured is boolean\n       \u001b[36mActual:\u001b[0m   stripeConfigured: true\n  \u001b[32mPASS\u001b[0m Response contains supabaseConfigured boolean\n       \u001b[36mExpected:\u001b[0m supabaseConfigured is boolean\n       \u001b[36mActual:\u001b[0m   supabaseConfigured: true\n  \u001b[32mPASS\u001b[0m Response contains epsteinPhotosCount number\n       \u001b[36mExpected:\u001b[0m epsteinPhotosCount is number >= 0\n       \u001b[36mActual:\u001b[0m   epsteinPhotosCount: 3\n  \u001b[32mPASS\u001b[0m Response contains anonymousUsersTracked number\n       \u001b[36mExpected:\u001b[0m anonymousUsersTracked is number >= 0\n       \u001b[36mActual:\u001b[0m   anonymousUsersTracked: 0\n\n\u001b[1m=== 2. GET /api/photos ===\u001b[0m\n\u001b[33mPurpose: Returns Epstein photo gallery for frontend\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns HTTP 200 OK\n       \u001b[36mExpected:\u001b[0m HTTP status code 200\n       \u001b[36mActual:\u001b[0m   200\n  \u001b[32mPASS\u001b[0m Response contains photos array\n       \u001b[36mExpected:\u001b[0m photos is an array\n       \u001b[36mActual:\u001b[0m   photos array with 3 items\n  \u001b[32mPASS\u001b[0m Photos array is non-empty\n       \u001b[36mExpected:\u001b[0m At least 1 photo in gallery\n       \u001b[36mActual:\u001b[0m   3 photos\n  \u001b[32mPASS\u001b[0m Each photo has name field\n       \u001b[36mExpected:\u001b[0m photo.name is a string (human-readable name)\n       \u001b[36mActual:\u001b[0m   All 3 photos have name field\n  \u001b[32mPASS\u001b[0m Each photo has path field\n       \u001b[36mExpected:\u001b[0m photo.path starts with /epstein-photos/\n       \u001b[36mActual:\u001b[0m   All photos have valid path format\n  \u001b[32mPASS\u001b[0m Each photo has filename field\n       \u001b[36mExpected:\u001b[0m photo.filename is the actual file name\n       \u001b[36mActual:\u001b[0m   All photos have valid filename\n  \u001b[32mPASS\u001b[0m Photo files exist on disk\n       \u001b[36mExpected:\u001b[0m All referenced photos are accessible\n       \u001b[36mActual:\u001b[0m   First photo (epstein_bill_silk.jpg) is accessible\n\n\u001b[1m=== 3. GET /api/config ===\u001b[0m\n\u001b[33mPurpose: Returns client configuration (Supabase, tiers)\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns HTTP 200 OK\n       \u001b[36mExpected:\u001b[0m HTTP status code 200\n       \u001b[36mActual:\u001b[0m   200\n  \u001b[32mPASS\u001b[0m Response contains supabase object\n       \u001b[36mExpected:\u001b[0m supabase object with url and anonKey\n       \u001b[36mActual:\u001b[0m   supabase.url: configured\n  \u001b[32mPASS\u001b[0m Response contains tiers array\n       \u001b[36mExpected:\u001b[0m tiers is an array of tier definitions\n       \u001b[36mActual:\u001b[0m   3 tiers defined\n  \u001b[32mPASS\u001b[0m Tiers include anonymous, free, and paid\n       \u001b[36mExpected:\u001b[0m All three tier types are present\n       \u001b[36mActual:\u001b[0m   Tiers: anonymous, free, paid\n  \u001b[32mPASS\u001b[0m Each tier has required fields\n       \u001b[36mExpected:\u001b[0m id, name, limit, description\n       \u001b[36mActual:\u001b[0m   All tiers have required fields\n  \u001b[32mPASS\u001b[0m Anonymous tier has limit of 1\n       \u001b[36mExpected:\u001b[0m anonymous.limit = 1\n       \u001b[36mActual:\u001b[0m   anonymous tier limit is 1\n  \u001b[32mPASS\u001b[0m Free tier has limit of 3\n       \u001b[36mExpected:\u001b[0m free.limit = 3\n       \u001b[36mActual:\u001b[0m   free tier limit is 3\n  \u001b[32mPASS\u001b[0m Paid tier has unlimited limit\n       \u001b[36mExpected:\u001b[0m paid.limit = \"unlimited\"\n       \u001b[36mActual:\u001b[0m   paid tier limit is unlimited\n\n\u001b[1m=== 4. GET /api/me ===\u001b[0m\n\u001b[33mPurpose: Returns current user info and usage stats\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns HTTP 200 OK for anonymous user\n       \u001b[36mExpected:\u001b[0m HTTP status code 200 (works without auth)\n       \u001b[36mActual:\u001b[0m   200\n  \u001b[32mPASS\u001b[0m Anonymous user has authenticated=false\n       \u001b[36mExpected:\u001b[0m authenticated field is false\n       \u001b[36mActual:\u001b[0m   authenticated: false\n  \u001b[32mPASS\u001b[0m Anonymous user has null user object\n       \u001b[36mExpected:\u001b[0m user field is null\n       \u001b[36mActual:\u001b[0m   user: null\n  \u001b[32mPASS\u001b[0m Anonymous user has null profile object\n       \u001b[36mExpected:\u001b[0m profile field is null\n       \u001b[36mActual:\u001b[0m   profile: null\n  \u001b[32mPASS\u001b[0m Response contains usage object\n       \u001b[36mExpected:\u001b[0m usage object with tier info\n       \u001b[36mActual:\u001b[0m   usage object present\n  \u001b[32mPASS\u001b[0m Usage has tier=\"anonymous\" for anonymous user\n       \u001b[36mExpected:\u001b[0m usage.tier = \"anonymous\"\n       \u001b[36mActual:\u001b[0m   tier: anonymous\n  \u001b[32mPASS\u001b[0m Usage has limit=1 for anonymous user\n       \u001b[36mExpected:\u001b[0m usage.limit = 1\n       \u001b[36mActual:\u001b[0m   limit: 1\n  \u001b[32mPASS\u001b[0m Usage has used count\n       \u001b[36mExpected:\u001b[0m usage.used is a number >= 0\n       \u001b[36mActual:\u001b[0m   used: 0\n  \u001b[32mPASS\u001b[0m Usage has remaining count\n       \u001b[36mExpected:\u001b[0m usage.remaining is a number\n       \u001b[36mActual:\u001b[0m   remaining: 1\n  \u001b[32mPASS\u001b[0m Usage has canGenerate boolean\n       \u001b[36mExpected:\u001b[0m usage.canGenerate indicates if user can make requests\n       \u001b[36mActual:\u001b[0m   canGenerate: true\n  \u001b[32mPASS\u001b[0m Response contains tiers array\n       \u001b[36mExpected:\u001b[0m tiers info included for frontend display\n       \u001b[36mActual:\u001b[0m   3 tiers\n\n\u001b[1m=== 5. POST /api/generate ===\u001b[0m\n\u001b[33mPurpose: Generate face swap image\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns 400 without userPhoto\n       \u001b[36mExpected:\u001b[0m Error message about missing photo (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m Returns 400 without epsteinPhoto\n       \u001b[36mExpected:\u001b[0m Error message about missing selection (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m Returns 400 for invalid epsteinPhoto path\n       \u001b[36mExpected:\u001b[0m Rejects path traversal attempts (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m GET request to /api/generate returns error\n       \u001b[36mExpected:\u001b[0m Only POST method is handled (GET returns 404)\n       \u001b[36mActual:\u001b[0m   404: Route not found for GET method\n  \u001b[32mPASS\u001b[0m Skipping actual generation (requires GEMINI_API_KEY)\n       \u001b[36mExpected:\u001b[0m Would return imageUrl on success\n       \u001b[36mActual:\u001b[0m   API key is set - full test would require valid image\n\n\u001b[1m=== 6. GET /api/generations ===\u001b[0m\n\u001b[33mPurpose: Returns generation history (requires auth)\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns 401 for unauthenticated request\n       \u001b[36mExpected:\u001b[0m Authentication required error\n       \u001b[36mActual:\u001b[0m   401 Unauthorized\n  \u001b[32mPASS\u001b[0m Error response has error field\n       \u001b[36mExpected:\u001b[0m error field explains the issue\n       \u001b[36mActual:\u001b[0m   error: \"Authentication required\"\n  \u001b[32mPASS\u001b[0m Accepts limit query parameter\n       \u001b[36mExpected:\u001b[0m limit param should not cause error\n       \u001b[36mActual:\u001b[0m   401 (auth required, not bad param)\n\n\u001b[1m=== 7. GET /api/generation/:id ===\u001b[0m\n\u001b[33mPurpose: Returns specific generation by ID\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns 404 for non-existent ID\n       \u001b[36mExpected:\u001b[0m Generation not found error\n       \u001b[36mActual:\u001b[0m   404 Not Found\n  \u001b[32mPASS\u001b[0m Error response has error field\n       \u001b[36mExpected:\u001b[0m error field explains the issue\n       \u001b[36mActual:\u001b[0m   error: \"Generation not found\"\n  \u001b[32mPASS\u001b[0m Handles viewToken query parameter\n       \u001b[36mExpected:\u001b[0m viewToken is accepted (for anonymous generations)\n       \u001b[36mActual:\u001b[0m   404 (not found, token accepted)\n\n\u001b[1m=== Error Handling Tests ===\u001b[0m\n\u001b[33mPurpose: Verify proper error responses\u001b[0m\n\n  \u001b[32mPASS\u001b[0m Returns 404 for non-existent endpoint\n       \u001b[36mExpected:\u001b[0m /api/nonexistent returns 404\n       \u001b[36mActual:\u001b[0m   404 Not Found\n  \u001b[32mPASS\u001b[0m CORS headers are present\n       \u001b[36mExpected:\u001b[0m Access-Control headers in response\n       \u001b[36mActual:\u001b[0m   CORS configured\n  \u001b[32mPASS\u001b[0m JSON responses have correct content-type\n       \u001b[36mExpected:\u001b[0m application/json; charset=utf-8\n       \u001b[36mActual:\u001b[0m   application/json; charset=utf-8\n\n\u001b[1m=== Subscription Endpoints ===\u001b[0m\n\u001b[33mPurpose: Stripe subscription management\u001b[0m\n\n  \u001b[32mPASS\u001b[0m GET /api/subscription requires auth\n       \u001b[36mExpected:\u001b[0m Returns 401 without authentication\n       \u001b[36mActual:\u001b[0m   401 (auth required)\n  \u001b[32mPASS\u001b[0m POST /api/create-checkout requires auth\n       \u001b[36mExpected:\u001b[0m Returns 400/401 without authentication (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m POST /api/cancel-subscription requires auth\n       \u001b[36mExpected:\u001b[0m Returns 400/401 without authentication\n       \u001b[36mActual:\u001b[0m   401 (validation or auth required)\n\n\u001b[1m=== Admin Endpoints ===\u001b[0m\n\u001b[33mPurpose: Admin debug mode management\u001b[0m\n\n  \u001b[32mPASS\u001b[0m GET /api/admin/status works without auth\n       \u001b[36mExpected:\u001b[0m Returns isAdmin: false\n       \u001b[36mActual:\u001b[0m   isAdmin: false, adminConfigured: true\n  \u001b[32mPASS\u001b[0m POST /api/admin/login requires password\n       \u001b[36mExpected:\u001b[0m Returns 400 without password (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m POST /api/admin/login rejects wrong password\n       \u001b[36mExpected:\u001b[0m Returns 401 for invalid credentials (or 429 if rate limited)\n       \u001b[36mActual:\u001b[0m   429: Rate limited (expected in rapid testing)\n  \u001b[32mPASS\u001b[0m GET /api/admin/debug requires admin auth\n       \u001b[36mExpected:\u001b[0m Returns 401 without admin token\n       \u001b[36mActual:\u001b[0m   401 Unauthorized\n  \u001b[32mPASS\u001b[0m POST /api/admin/logout works without auth\n       \u001b[36mExpected:\u001b[0m Always returns success\n       \u001b[36mActual:\u001b[0m   success: true\n\n============================================================\n\u001b[1mTest Summary\u001b[0m\n============================================================\n\u001b[32mPassed:\u001b[0m 56\n\u001b[31mFailed:\u001b[0m 0\nTotal:  56\n\n\u001b[32mAll tests passed!\u001b[0m\n\n============================================================\n\u001b[1mEndpoint Summary\u001b[0m\n============================================================\n\n1. GET /api/health\n   - Returns server status and configuration\n   - Fields: status, apiKeySet, stripeConfigured, supabaseConfigured, epsteinPhotosCount\n\n2. GET /api/photos\n   - Returns Epstein photo gallery\n   - Fields: photos[] with name, path, filename\n\n3. GET /api/config\n   - Returns client configuration\n   - Fields: supabase (url, anonKey), tiers[]\n\n4. GET /api/me\n   - Returns current user info and usage\n   - Works for anonymous users (authenticated=false)\n   - Fields: authenticated, user, profile, usage, tiers\n\n5. POST /api/generate\n   - Generates face swap image\n   - Requires: userPhoto (file), epsteinPhoto (path)\n   - Returns: imageUrl, generationId\n\n6. GET /api/generations\n   - Returns generation history\n   - Requires authentication (401 otherwise)\n   - Supports: ?limit=N\n\n7. GET /api/generation/:id\n   - Returns single generation by ID\n   - Supports: ?viewToken for anonymous access\n   - Returns 404 for non-existent ID\n\nAdditional endpoints:\n- GET /api/subscription (requires auth)\n- POST /api/create-checkout (requires auth)\n- POST /api/cancel-subscription (requires auth)\n- GET/POST /api/admin/* (admin endpoints)\n\n",
      "passed": 0,
      "failed": 0
    },
    {
      "name": "e2e-full",
      "description": "End-to-End Tests",
      "status": "failed",
      "exitCode": 1,
      "duration": 102,
      "output": "============================================================\nPimp My Epstein - End-to-End Tests\n============================================================\nTarget: http://localhost:3000\nTime:   2025-12-29T04:41:03.043Z\n\nServer is running and healthy.\n\n\n  STEP 1: Load Homepage\n  User navigates to the main application page\n    [PASS] Homepage returns 200 OK\n    [PASS] Homepage contains correct title\n    [PASS] Homepage includes Supabase client script\n    [PASS] Homepage has security headers\n    [PASS] Health check confirms API is functional\n\n  STEP 2: View Photo Gallery\n  User browses available Epstein photos\n    [PASS] Photos API returns array of photos\n    [PASS] At least one photo is available\n    [PASS] Each photo has required metadata fields\n    [PASS] Photo paths start with /epstein-photos/\n    [PASS] Photo images are accessible via their paths\n\n  STEP 3: Select a Photo\n  User picks an Epstein photo for the swap\n    [PASS] First photo from gallery is valid for selection\n    [FAIL] Photo selection is accepted by generate endpoint validation\n           Error: Should return 400 for missing userPhoto\n\n  STEP 4: Upload a Test Image\n  User uploads their face photo\n    [FAIL] Generate endpoint rejects missing epsteinPhoto\n           Error: Should return 400 for missing epsteinPhoto\n    [FAIL] Generate endpoint rejects invalid file types\n           Error: Should return 400 for invalid file type\n    [FAIL] Generate endpoint rejects images that are too small\n           Error: Should return 400 for too-small image\n    [FAIL] Generate endpoint validates path traversal attempts\n           Error: Should reject path traversal attempt\n\n  STEP 5: Click Generate\n  Test generation (may fail without API key)\n    [PASS] Generate endpoint requires authentication for tracking\n    [PASS] Usage info is available via /api/me\n\n  STEP 6: Admin Login Flow\n  Test debug mode authentication\n    [PASS] Admin status check works for non-admin\n    [FAIL] Admin login rejects empty password\n           Error: Should return 400 for empty password\n    [FAIL] Admin login rejects invalid password\n           Error: Should return 401 for wrong password\n    [FAIL] Admin login with correct password sets httpOnly cookie\n           Error: Should return 401 if password wrong\n    [PASS] Admin debug endpoint requires authentication\n           (Skipped - no admin session available)\n    [PASS] Admin debug endpoint works with valid session\n\n  STEP 7: Logout Flow\n  Test admin session termination\n    [PASS] Logout endpoint clears admin session\n    [PASS] After logout, admin status is false\n    [PASS] After logout, admin debug endpoint returns 401\n\n  STEP 8: Upgrade Button\n  Test Stripe checkout flow (requires auth)\n    [PASS] Upgrade page is accessible\n    [FAIL] Checkout endpoint requires authentication\n           Error: Should return 401 for unauthenticated user\n    [PASS] Subscription endpoint requires authentication\n    [PASS] Cancel subscription endpoint requires authentication\n    [PASS] Config endpoint returns tier information\n    [PASS] Generations history requires authentication\n\n  SECURITY TESTS\n  Additional security validation\n    [FAIL] Output directory is not directly accessible\n           Error: Output files should not be directly accessible, got 429\n    [FAIL] CORS is properly configured\n           Error: Request should succeed\n    [PASS] Non-existent API routes return 404\n    [PASS] Rate limiting headers are present\n\n============================================================\nTest Summary\n============================================================\nPassed: 26\nFailed: 11\nTotal:  37\n\nFailed Tests:\n  - Photo selection is accepted by generate endpoint validation\n    Should return 400 for missing userPhoto\n  - Generate endpoint rejects missing epsteinPhoto\n    Should return 400 for missing epsteinPhoto\n  - Generate endpoint rejects invalid file types\n    Should return 400 for invalid file type\n  - Generate endpoint rejects images that are too small\n    Should return 400 for too-small image\n  - Generate endpoint validates path traversal attempts\n    Should reject path traversal attempt\n  - Admin login rejects empty password\n    Should return 400 for empty password\n  - Admin login rejects invalid password\n    Should return 401 for wrong password\n  - Admin login with correct password sets httpOnly cookie\n    Should return 401 if password wrong\n  - Checkout endpoint requires authentication\n    Should return 401 for unauthenticated user\n  - Output directory is not directly accessible\n    Output files should not be directly accessible, got 429\n  - CORS is properly configured\n    Request should succeed\n\n",
      "passed": 0,
      "failed": 0
    }
  ]
}